<!doctype html>
<head>
  <title>Night Watch</title>
  <!-- TODO: Need icon -->
  <link rel="icon" href="icon128.png" />
  <script>
function val(name) {
  var $ = document.getElementById(name).value;
  return ($ ? $ : undefined);
}

function setVal(name, val) {
  document.getElementById(name).value = val;
}

function parseTimeField() {
  document.getElementById("timeParsed").innerHTML =
      new Date(val('time')).toString();
}

function post(state) {
  var post = {
    'content': val('content'),
    'share_id': val('share_id'),
    'timeStamp': new Date(val('time')).getTime(),
    'writeTimeStamp': new Date().getTime()
  }
  var link = val('link');
  if (link) {
    post.link = link;
  }
  chrome.extension.sendRequest({'type': 'post', 'post': post, 'state': state || 'draft'}, drafts);
}

function processMediaItems(mediaArray) {
  var result = {'images': [], 'link': {}};
  mediaArray.forEach(function(media) {
    var type = media[24][3];
    if (!type) {
      return;
    }
    if (type == 'image/jpeg') {
      var image = {'url': media[5][1], '2': media[24][12], 'h': media[24][13]};
      result.images.push(image);
    } else if (type == "text/html") {
      result.link = {'url': media[24][1], 'title': media[3], 'description': media[21]};
    }
  });
  return result;
}

function delPost(state, timeStamp) {
  chrome.extension.sendRequest({'type': 'delPost', 'state': state, 'timeStamp': timeStamp}, drafts);
}

function getDateString(post) {
  if (post.timeStamp) {
    return "Will be posted on " + new Date(post.timeStamp).toString();
  } else {
    return "Written on " + new Date(post.writeTimeStamp).toString();
  }
}

function renderPost(post) {
  var div = document.createElement('div');
  div.style.border = "1px solid black";
  div.style.width = "600px";
  var date = getDateString(post);
  if (post.rawMedia) {
    var medias = processMediaItems(post.rawMedia);
    var image = medias.images[0];
    var link = medias.link;
  }
  var isDraft = !post.timeStamp;
  div.innerHTML = "<small>" + date + "</small><br>" +
                  post.content + "<br>\n" +
                  (link && link.title ? "<h3>" + link.title + "</h3>\n" : "") +
                  (image ? "<img src='" + image.url + "' width='" + image.w +
                    "' height='" + image.h + "' /"+">" : "") +
                  (link && link.description ? "<p>" + link.description + "</p>" : "") +
                  "<button onclick='delPost(" +
                  (isDraft ? "\"draft\", " + post.writeTimeStamp : "\"scheduled\", " + post.timeStamp) +
                  ")'>Delete</button>";
  return div;
}

function drafts() {
  chrome.extension.sendRequest({'type': 'fetchAll'}, function(result) {
    var postsDiv = document.getElementById('posts');
    postsDiv.innerHTML = '';
    result.posts && result.posts.forEach(function(post) {
      postsDiv.appendChild(renderPost(post));
    });
  });
}
  </script>
</head>
<body onload="drafts()">
  <div style="border: 1px solid black; width: 600px;">
    <p><textarea id='content' cols="70" rows="10">Content</textarea></p>
    <p id='timeParsed'></p>
    <p><input id='share_id' placeholder="shared id" /></p>
    <p><input id='link' placeholder="link" /></p>
    <p><input id='time' placeholder="Time" /><button onclick='parseTimeField()'>Parse</button></p>
    <button onclick="post('draft')">Save Draft</button>
    <button onclick="post('scheduled')">Schedule</button>
</div>
<div id="posts">
</div>
