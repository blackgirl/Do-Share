<!doctype html>
<head>
  <title>Night Watch</title>
  <!-- TODO: Need icon -->
  <link rel="icon" href="icon128.png" />
  <script>
function val(name) {
  var $ = document.getElementById(name).value;
  return ($ ? $ : undefined);
}

function setVal(name, val) {
  document.getElementById(name).value = val;
}

function parseTimeField() {
  document.getElementById("timeParsed").innerHTML =
      new Date(val('time')).toString();
}

function post(state, writeTimeStamp) {
  var id = writeTimeStamp || '';
  var post = {
    'state': state,
    'content': val('content' + id) || '',
    'share_id': val('share_id' + id),
    'timeStamp': new Date(val('time' + id)).getTime() || undefined,
    'writeTimeStamp': writeTimeStamp || new Date().getTime()
  }
  var link = val('link' + id);
  if (link) {
    post.link = link;
  }
  chrome.extension.sendRequest({'type': 'post', 'post': post, 'state': state}, drafts);
}

function processMediaItems(mediaArray) {
  var result = {'images': [], 'link': {}, 'video': {}};
  mediaArray.forEach(function(media) {
    var type = media[24][3];
    if (!type) {
      return;
    }
    if (type == 'image/jpeg') {
      var image = {'url': media[5][1], 'w': media[24][12], 'h': media[24][13]};
      result.images.push(image);
    }
    if (type == "text/html" || type == "application/x-shockwave-flash") {
      result.link = {'url': media[24][1], 'title': media[3], 'description': media[21]};
    }
    if (type == "application/x-shockwave-flash") {
      result.video = {'embed': media[5][1].replace(/autoplay=1/, ''), 'w': media[5][3], 'h': media[5][2]};
    }
  });
  return result;
}

function delPost(writeTimeStamp) {
  chrome.extension.sendRequest({'type': 'delPost', 'writeTimeStamp': writeTimeStamp}, drafts);
}

function getDateString(post) {
  if (post.state == 'scheduled') {
    return "Will be posted on " + new Date(post.timeStamp).toString();
  } else {
    return "Written on " + new Date(post.writeTimeStamp).toString();
  }
}

function publishDraft(writeTimeStamp) {
  chrome.extension.sendRequest({'type': 'publishDraft', 'writeTimeStamp': writeTimeStamp},
      function(ok) {
    if (ok) {
      var draftDiv = document.getElementById("d" + writeTimeStamp);
      draftDiv.parentElement.removeChild(draftDiv);
    }
  });
}

function addDraftEditBox(parent, post) {
  var writeTimeStamp = (post && post.writeTimeStamp) || '';
  var content = (post && post.content) || '';
  var share_id = (post && post.share_id) || '';
  var link = '';
  if (post && post.rawMedia) {
    var medias = processMediaItems(post.rawMedia);
    link = medias.link.url || '';
  }
  var div = document.createElement('div');
  div.innerHTML =
    ("<p><textarea id='content$' cols=70 rows=10>" + content + "</textarea></p>" +
    "<p><input id='share_id$' placeholder='shared id' value='" + share_id + "'></input></p>" +
    "<p><input id='link$' placeholder='link' value='" + link + "'></input></p>" +
    "<p><input id='time$' placeholder='Time' /"+"><button onclick='parseTimeField($)'>Parse</button></p>" +
    "<p id='timeParsed$'></p>" +
    "<button onclick='post(\"draft\", %)'>Save Draft</button>" +
    "<button onclick='post(\"scheduled\", %)'>Schedule</button>" +
    "<button onclick='post(\"post\", %)'>Post immediately</button>")
        .replace(/\$/g, writeTimeStamp || '')
        .replace(/%/g, writeTimeStamp || 'undefined');
  parent.appendChild(div);
}

function editDraft(writeTimeStamp) {
  chrome.extension.sendRequest({type: 'fetchPost', writeTimeStamp: writeTimeStamp},
      function(post) {
    var e = document.getElementById('d' + writeTimeStamp);
    e.innerHTML = '';
    addDraftEditBox(e, post);
  });
}

function unpublish(writeTimeStamp) {
  if (confirm("Unpublishing will remove the post from the queue. It will still be available as a draft.")) {
    chrome.extension.sendRequest({'type': 'fetchPost', 'writeTimeStamp': writeTimeStamp},
        function(post) {
      chrome.extension.sendRequest({'type': 'post', 'post': post, 'state': 'draft'}, drafts);
    });
  }
}

function renderPost(post) {
  var div = document.createElement('div');
  var date = getDateString(post);
  if (post.rawMedia) {
    var medias = processMediaItems(post.rawMedia);
    // TODO: Scroll through images.
    var image = medias.images[0];
    var video = medias.video;
    var link = medias.link;
  }
  var isDraft = (post.state == 'draft');
  div.id = (isDraft ? "d" : "s" ) + post.writeTimeStamp;

  // Don't look at this :(
  div.innerHTML = "<small>" + date + "</small><br>" +

                  post.content + "<br>" +

                  (link && link.title ? "<h3>" + link.title + "</h3>" : "") +

                  (image ? "<img src='" + image.url + "' width='" + image.w +
                    "' height='" + image.h + "' /"+">" : "") +

                  (video ? "<iframe src='" + video.embed + "' width='" + video.w +
                      "' height='" + video.h + "' ></iframe>" : '') +

                  (link && link.description ? "<p>" + link.description + "</p>" : "") +

                  "<button onclick='delPost(" + post.writeTimeStamp + ")'>Delete</button>" +

                  (isDraft ?
                      "<button onclick='publishDraft(" + post.writeTimeStamp + ")'>Publish</button>" +
                      "<button onclick='editDraft(" + post.writeTimeStamp + ")'>Edit draft</button>"
                      :
                      "<button onclick='unpublish(" + post.writeTimeStamp + ")'>Unpublish</button>");
  return div;
}

function drafts() {
  chrome.extension.sendRequest({'type': 'fetchAll'}, function(result) {
    var postsDiv = document.getElementById('posts');
    postsDiv.innerHTML = '';
    result.posts && result.posts.forEach(function(post) {
      postsDiv.appendChild(renderPost(post));
    });
  });
}

function onLoad() {
  addDraftEditBox(document.getElementById('editbox'));
  drafts();
}

  </script>
</head>
<body onload="onLoad()">
  <div id="editbox"></div>
  <div id="posts"></div>
