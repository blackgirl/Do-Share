<!doctype html>
<head>
  <meta charset="utf-8">
  <title>Night Watch</title>
  <!-- TODO: Need icon -->
  <link rel="icon" href="icon128.png" />
  <link rel="stylesheet" href="style.css" />

<script src="opera_wysiwyg/utils.js"></script>
<script src="opera_wysiwyg/editor.js"></script>
<script src="opera_wysiwyg/editlib.js"></script>
<script src="gp_editor.js"></script>

<script src="libs/jquery-1.7.1.min.js"></script>
<script src="libs/jquery-ui-1.8.18.custom.min.js"></script>
<link rel="stylesheet" type="text/css" href="jqueryui_css/ui-lightness/jquery-ui-1.8.18.custom.css"> 

  <script>
var mem = {};
var gpe = {};

var postsCurrentlyDisplayed = [];

var lastUpdate;

function val(name) {
  var $ = document.getElementById(name).value;
  return ($ ? $ : undefined);
}

function setVal(name, val) {
  document.getElementById(name).value = val;
}

function parseTimeField(id) {
  document.getElementById("timeParsed" + id).innerHTML =
      new Date(val('time' + id)).toString();
}

function sendPost(post) {
  chrome.extension.sendRequest({'type': 'post', 'post': post}, refresh);
}

function post(state, writeTimeStamp) {
  var id = writeTimeStamp || '';
  var post = {
    'state': state,
    'content': getContent(id),
    'share_id': val('share_id' + id),
    'image_id': val('image_id' + id),
    'timeStamp': new Date(val('time' + id)).getTime() || undefined,
    'link': val('link' + id) || undefined,
  }
  if (writeTimeStamp) {
    post.writeTimeStamp = writeTimeStamp;
    var savedPost = mem[writeTimeStamp];
    if (savedPost) {
      post.reshare = savedPost.reshare;
    }
  } else {
    post.writeTimeStamp = new Date().getTime();
  }
  sendPost(post);
}

function processMediaItems(mediaArray) {
  var result = {'images': []};
  mediaArray.forEach(function(media) {
    if (media[24][4] == "image") {
      var url = media[41][0][1];
      if (!url.match(/http/)) {
        url = 'https:' + url;
      }
      var image = {'url': url};
      result.images.push(image);
    }
    var type = media[24][3];
    if (type == "text/html" || type == "application/x-shockwave-flash") {
      result.link = {'url': media[24][1], 'title': media[3], 'description': media[21]};
    }
    if (type == "application/x-shockwave-flash") {
      result.video = {'embed': media[5][1].replace(/autoplay=1/, ''), 'w': media[5][3], 'h': media[5][2]};
    }
  });
  return result;
}

function delPost(writeTimeStamp) {
  chrome.extension.sendRequest({'type': 'delPost', 'writeTimeStamp': writeTimeStamp}, refresh);
}

function getDateString(post) {
  if (post.state == 'scheduled') {
    return "Will be posted on " + new Date(post.timeStamp).toString();
  } else {
    return "Written on " + new Date(post.writeTimeStamp).toString();
  }
}

function publishDraft(writeTimeStamp) {
  chrome.extension.sendRequest({'type': 'publishDraft', 'writeTimeStamp': writeTimeStamp},
      function(ok) {
    if (ok) {
      var draftDiv = document.getElementById('post' + writeTimeStamp);
      draftDiv.parentElement.removeChild(draftDiv);
    }
  });
}

function getContent(writeTimeStamp) {
  var g = gpe[writeTimeStamp];
  if (g) {
    return g.getText();
  }
}

function profileAutocompleter(prefix, callback) {
  chrome.extension.sendRequest({type: 'profileAutocomplete', prefix: prefix}, callback);
}

function addDraftEditBox(parent, post) {
  if (!post) {
    post = {};
  }
  var writeTimeStamp = post.writeTimeStamp || '';
  var content = post.content || '';
  var share_id = post.share_id || '';
  var link = post.link || '';
  var image_id = post.image_id || '';
  if (post.rawMedia) {
    var medias = processMediaItems(post.rawMedia);
    link = medias.link && medias.link.url || '';
  }
  var div = document.createElement('div');
  div.innerHTML =
    (("<div id='content{$}' class='editbox'></div>" +
    "<p><input type='hidden' id='share_id{$}' placeholder='shared id' value='" + share_id + "'></input></p>" +
    "<p><input id='link{$}' placeholder='link' value='" + link + "'></input></p>" +
    "<p><input id='time{$}' placeholder='Time' /"+"><button onclick='parseTimeField({%})'>Parse</button></p>" +
    "<p><input type='hidden' id='image_id{$}' placeholder='image_id' value='" + image_id + "'></input></p>" +
    "<p id='timeParsed{$}'></p>").replace(/{\$}/g, writeTimeStamp).replace(/{%}/g, writeTimeStamp || '""') +
    renderReshare(post) +
    ("<br>" +
    "<button onclick='post(\"draft\", %)'>Save Draft</button>" +
    "<button onclick='post(\"scheduled\", %)'>Schedule</button>" +
    "<button onclick='post(\"post\", %)'>Post immediately</button>").replace(/%/g, writeTimeStamp || 'undefined'));

  if (parent.children.length > 0) {
    parent.removeChild(parent.children[0]);
  }
  parent.appendChild(div);
  gpe[writeTimeStamp] = new GPEditor(document.getElementById('content' + writeTimeStamp),
      content, writeTimeStamp, profileAutocompleter);
}

function renderReshare(post) {
  if (!(post && post.reshare)) {
    return '';
  }
  var rs = post.reshare;
  return '<h2>' + rs.author_name + ' originally shared this ' +
         '<a href="' + rs.url + '">post</a> ' +
         (rs.via_name ? ' (via ' + rs.via_name + ')' : '') +
         ':</h2>' +
         '<p>' + rs.content.replace(/(class=\'ot-hashtag\' href=\')/g, "$1https://plus.google.com/") + '</p>' +
         (rs.rawMedia ? renderMediaItems(processMediaItems(rs.rawMedia)) : '');
}

function editDraft(writeTimeStamp) {
  chrome.extension.sendRequest({type: 'fetchPost', writeTimeStamp: writeTimeStamp},
      function(post) {
    stopRefreshing = true;
    var e = document.getElementById('post' + writeTimeStamp);
    e.innerHTML = '';
    addDraftEditBox(e, post);
  });
}

function unpublish(writeTimeStamp) {
  if (confirm("Unpublishing will remove the post from the queue. It will still be available as a draft.")) {
    chrome.extension.sendRequest({'type': 'fetchPost', 'writeTimeStamp': writeTimeStamp},
        function(post) {
      post.state = 'draft';
      sendPost(post);
    });
  }
}

function bMinusA(a, b, key) {
  var aKeys = a.map(function(item){return item[key]});
  return b.filter(function(item) {
    return aKeys.indexOf(item[key]) == -1;
  });
}

function removeRemovedPosts(removedPosts) {

}

function renderAllPosts(posts) {
  if (!posts instanceof Array) {
    return;
  }
  var removedPosts = bMinusA(posts, postsCurrentlyDisplayed, 'writeTimeStamp');
  postsCurrentlyDisplayed = posts;
  removeRemovedPosts(removedPosts);
  posts.forEach(function(post) {
    renderPost(post);
  });
}

function renderPost(post) {
  var div = document.createElement('div');
  var date = getDateString(post);
  var attachmentHTML = '';
  if (post.reshare) {
    attachmentHTML = renderReshare(post);
  } else if (post.rawMedia) {
    attachmentHTML = renderMediaItems(processMediaItems(post.rawMedia));
  }
  var isDraft = (post.state == 'draft');
  div.id = 'post' + post.writeTimeStamp;

  // Don't look at this :(
  div.innerHTML = "<small>" + date + "</small><br>" +

                  GPEditor.prototype.plusFormatToHtml(post.content) + "<br>" +

                  attachmentHTML +

                  "<button onclick='delPost(" + post.writeTimeStamp + ")'>Delete</button>" +

                  (isDraft ?
                      "<button onclick='publishDraft(" + post.writeTimeStamp + ")'>Publish</button>" +
                      "<button onclick='editDraft(" + post.writeTimeStamp + ")'>Edit draft</button>"
                      :
                      "<button onclick='unpublish(" + post.writeTimeStamp + ")'>Unpublish</button>");
  var column = document.querySelector('#posts ' +  (isDraft ? '.drafts' : '.scheduled'));
  column.appendChild(div);
}

function renderMediaItems(medias) {
  // TODO: Scroll through images.
  var image = medias.images[0];
  var video = medias.video;
  var link = medias.link;

  return (link && link.title ?
      "<a href='" + link.url +"'>" +
      "<h3>" + link.title + "</h3></a>" : "") +

  (image ? "<img src='" + image.url + "'><br>" : "") +

  (video ? "<iframe src='" + video.embed + "' width='" + video.w +
      "' height='" + video.h + "' ></iframe>" : '') +

  (link && link.description ? "<p>" + link.description + "</p>" : "");
}

function refresh() {
  addDraftEditBox(document.getElementById('editbox'));
  refreshPosts();
}

var stopRefreshing;
function refreshPosts() {
  stopRefreshing = false;
  chrome.extension.sendRequest({'type': 'fetchAll'}, function(result) {
    if (stopRefreshing || result.lastUpdate == lastUpdate) {
      return;
    }
    lastUpdate = result.lastUpdate;
    result.posts && renderAllPosts(result.posts);
  });
}

function refreshIfNeeded() {
  if (!stopRefreshing) {
    refreshPosts();
  }
  window.setTimeout(refreshIfNeeded, 300);
}

function onLoad() {
  var savedPostJson = localStorage['_tmp_post'];
  var savedPost;
  if (savedPostJson) {
    savedPost = JSON.parse(savedPostJson);
    mem[savedPost.writeTimeStamp] = savedPost;
  }
  localStorage.clear('_tmp_post');
  addDraftEditBox(document.getElementById('editbox'), savedPost);
  refreshIfNeeded();
}

  </script>
</head>
<body onload="onLoad()">
  <div id="appWrap">
    <div id="top">
      <header><h1>Do Share</h1></header>
    </div>
    <div id="editbox"></div>
    <div id="posts">
      <div class="drafts"></div>
      <div class="scheduled"></div>
    </div>
  </div>
