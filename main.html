<!doctype html>
<head>
  <meta charset="utf-8">
  <title>Do Share</title>
  <link rel="icon" href="icon128.png" />
  <link rel="stylesheet" href="roboto/roboto.css" />
  <link rel="stylesheet" href="style.css" />

<script src="opera_wysiwyg/utils.js"></script>
<script src="opera_wysiwyg/editor.js"></script>
<script src="opera_wysiwyg/editlib.js"></script>
<script src="gp_editor.js"></script>

<script src="libs/jquery-1.7.1.min.js"></script>
<script src="libs/jquery-ui-1.8.19.custom.min.js"></script>
<link rel="stylesheet" type="text/css" href="jqueryui_css/ui-lightness/jquery-ui-1.8.19.custom.css">

<script src="libs/jquery-ui-timepicker-addon.js"></script>
<link rel="stylesheet" href="libs/jquery-ui-timepicker-addon.css" />

<script src="libs/moment.min.js"></script>

<script>

/**
 * jQuery setup.
 */

// http://stackoverflow.com/questions/1818670/how-to-control-positioning-of-jqueryui-datepicker
$.extend($.datepicker,{_checkOffset:function(inst,offset,isFixed){return offset}});

/**
 * Don't hide the date picker when clicking a date
 * http://stackoverflow.com/a/1762378/153264
 */
$.datepicker._selectDateOverload = $.datepicker._selectDate;
$.datepicker._selectDate = function(id, dateStr) {
    var target = $(id);
    var inst = this._getInst(target[0]);
    inst.inline = true;
    $.datepicker._selectDateOverload(id, dateStr);
    inst.inline = false;
    this._updateDatepicker(inst);
}

/** **/

var mem = {};
var touch = {};
var needRefresh = false;
var gpe;
var audienceChooser;

var postsCurrentlyDisplayed = [];

var currentMedias;

var lastUpdate = 0;

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-27041781-6']);
_gaq.push(['_trackPageview']);

function trackSchedule(post) {
  if (post.timeStamp) {
     _gaq.push(['_trackEvent', 'Schedule', 'future', 'future', Math.floor((post.timeStamp - new Date().getTime()) / 1000)]);
  }
}

function trackClick(buttonName) {
  _gaq.push(['_trackEvent', buttonName, 'Clicked']);
}

function val(name) {
  var $ = document.getElementById(name).value;
  return ($ ? $ : undefined);
}

function sendPost(post) {
  if (post.state == 'autosave') {
    post.state = document.querySelector('.scheduled #post' + post.writeTimeStamp) ? 'scheduled' : 'draft';
    chrome.extension.sendRequest({'type': 'post', 'post': post}, refreshPosts);
    $('#write_time_stamp').val(post.writeTimeStamp);
  } else {
    chrome.extension.sendRequest({'type': 'post', 'post': post}, refresh);
  }
}

function getEditedPost(state, writeTimeStamp) {
  var mentioned = (mem[writeTimeStamp] && mem[writeTimeStamp].mentioned) || {};
  for (var id in gpe._mentioned) {
    mentioned[id] = gpe._mentioned[id];
  }
  return {
    'state': state,
    'content': getContent() || '',
    'share_id': val('share_id'),
    'reshare': (mem[writeTimeStamp] && mem[writeTimeStamp].reshare) || undefined,
    'image_id': val('image_id'),
    'title': val('title'),
    'entities': audienceChooser.getEntities(),
    'timeStamp': new Date(Number(val('time'))).getTime() || undefined,
    'link': val('link') || undefined,
    'touch': new Date().getTime(),
    'mentioned': mentioned,
    'medias': currentMedias
  };
}

function isEmptyPost(post) {
  for (var key in post) {
    if (key == 'mentioned') {
      continue;
    }
    if (key == 'entities' && post[key]) {
      // If the user entered only a few items, consider the post empty.
      if (post[key].length > 3) {
        return false;
      }
    } else if (post[key] && key != 'touch') {
      return false;
    }
  }
  return true;
}

function post(state) {
  var writeTimeStamp = Number(val('write_time_stamp') || 0);
  var post = getEditedPost(state, writeTimeStamp);
  if (writeTimeStamp) {
    post.writeTimeStamp = writeTimeStamp;
    var savedPost = mem[writeTimeStamp];
    if (savedPost) {
      post.reshare = savedPost.reshare;
    }
  } else {
    post.writeTimeStamp = new Date().getTime();
  }
  sendPost(post);
  if (state == 'scheduled') {
    trackSchedule(post);
  }
  if (state != 'autosave') {
    blinkPost(writeTimeStamp);
    localStorage['lastUsedCircles'] = JSON.stringify(post.entities.filter(function(entity) {
      // Save only circles.
      return !!entity.circleId;
    }));
  }
}

function blinkPost(writeTimeStamp) {
  var post = $('#post' + writeTimeStamp);
  post.addClass('activity');
  window.setTimeout(function(){post.removeClass('activity')}, 400);
}

function delPost() {
  var writeTimeStamp = Number(val('write_time_stamp'));
  if (document.getElementById('post' + writeTimeStamp)) {
    chrome.extension.sendRequest({'type': 'delPost', 'writeTimeStamp': writeTimeStamp}, refresh);
  } else {
    refresh();
  }
}

function getDateString(post) {
  if (post.state == 'scheduled') {
    return moment(post.timeStamp).format('dddd, MMMM Do YYYY [at] H:mm');
  } else {
    return '';
  }
}

function getContent() {
  return gpe && gpe.getText();
}

function profileAutocompleter(prefix, callback) {
  chrome.extension.sendRequest({type: 'profileAutocomplete', prefix: prefix}, callback);
}

function populateTimeFields(timeStamp) {
  if (timeStamp) {
    function f(t) {
      if (String(t).length == 1) {
        return '0' + t;
      } else {
        return String(t);
      }
    }
    $('#time').val(timeStamp);
    var d = new Date(timeStamp);
    $('#dateInput').val(f(d.getMonth() + 1) + '/' + f(d.getDate()) + '/' + d.getFullYear());
    $('#timeInput').val(f(d.getHours()) + ':' + f(d.getMinutes()) + (d.getSeconds() ? ':' + f(d.getSeconds()) : ''));
  } else {
    $('#dateInput').val('');
    $('#timeInput').val('');
    $('#time').val('');
  }
}

function addDraftEditBox(post) {
  if (!post) {
    post = {};
    var lastUsed = localStorage['lastUsedCircles'];
    if (lastUsed) {
      post.entities = JSON.parse(lastUsed);
    } else {
      post.entities = [];
    }
  }
  var writeTimeStamp = post.writeTimeStamp || '';
  var content = post.content || '';
  var share_id = post.share_id || '';
  var link = (!post.reshare && post.link) || '';
  var image_id = post.image_id || '';
  var title = post.title || '';
  var timeStamp = post.timeStamp;
  var entities = post.entities || [];
  var mentioned = post.mentioned || {};
  var medias = post.medias;
  if (medias) {
    link = medias.link && medias.link.url || '';
  }
  currentMedias = medias;

  if (gpe) {
    gpe.destroy();
  }
  gpe = new GPEditor(document.getElementById('content'),
      content, writeTimeStamp, profileAutocompleter, mentioned);

  $('#title').val(title);
  $('#share_id').val(share_id);
  $('#link, #linkInput').val(link);
  $('#image_id').val(image_id);
  $('#write_time_stamp').val(writeTimeStamp);

  populateTimeFields(timeStamp);

  audienceChooser = new AudienceChooser(entities);

  if (post.reshare) {
    $('#reshare').html(renderReshare(post));
    $('#addLinkAction').attr({'class': 'invalid'});
  } else {
    $('#reshare').html('');
    $('#addLinkAction').attr({'class': 'enabled'});
    populateEditorMediaArea(post.medias);
  }

  if (link || post.reshare || post.medias) {
    $('#attachments').addClass('notempty');
  } else {
    $('#attachments').removeClass('notempty');
  }
}

function renderReshare(post) {
  if (!(post && post.reshare)) {
    return '';
  }
  var rs = post.reshare;
  return '<div class="reshare"><h2>' + rs.author_name + ' originally shared this ' +
         '<a href="' + rs.url + '">post</a> ' +
         (rs.via_name ? ' (via ' + rs.via_name + ')' : '') +
         ':</h2>' +
         '<p>' + rs.content.replace(/(class=\'ot-hashtag\' href=\')/g, "$1https://plus.google.com/") + '</p>' +
         (rs.medias ? renderMediaItems(rs.medias) : '') + "</div>";
}

function renderReshareMeta(post) {
  if (!(post && post.reshare)) {
    return '';
  }
  var rs = post.reshare;
  return '<span class="reshareMeta">Reshared post by ' + rs.author_name + '</span>';
}

function editDraft(writeTimeStamp) {
  chrome.extension.sendRequest({type: 'fetchPost', writeTimeStamp: writeTimeStamp},
      function(post) {
    $('body').animate({scrollTop: 0}, 450);
    stopRefreshing = true;
    mem[post.writeTimeStamp] = post;
    addDraftEditBox(post);
    uncollapse();
  });
}

function bMinusA(a, b, key) {
  var aKeys = a.map(function(item){return item[key]});
  return b.filter(function(item) {
    return aKeys.indexOf(item[key]) == -1;
  });
}

function removeRemovedPosts(removedPosts) {
  removedPosts.forEach(function(post) {
    var p = $('#post' + post.writeTimeStamp);
    var interval = 1000;
    p.hide('blind', {}, interval);
    window.setTimeout(function() {
      p.remove();
    }, interval + 10);
  });
}

function getSavedPostMediaHtml(post) {
  function getMediaHtml(items) {
    var image = items.images[0];
    var video = items.video;
    if (video) {
      return "<iframe wmode='opaque' src='" + video.embed + "' width='260' ></iframe>";
    }
    if (image) {
      return "<img width='260' src='" + image.url + "' /" + ">";
    }
  };
  if (post.reshare && post.reshare.medias) {
    return getMediaHtml(post.reshare.medias);
  } else if (post.medias) {
    return getMediaHtml(post.medias);
  }
}

function renderAllPosts(posts) {
  if (!posts instanceof Array) {
    return;
  }
  var removedPosts = bMinusA(posts, postsCurrentlyDisplayed, 'writeTimeStamp');
  postsCurrentlyDisplayed = posts;
  removeRemovedPosts(removedPosts);
  posts.forEach(function(post) {
    renderPost(post);
  });
}

function renderPost(post) {
  if (post.touch && post.touch == touch[post.writeTimeStamp]) {
    return;
  }
  touch[post.writeTimeStamp] = post.touch;
  var div = document.createElement('div');
  var date = getDateString(post);
  var title = post.title || '';

  var error = post.error || '';

  var postMedia = getSavedPostMediaHtml(post) || '';

  div.id = 'post' + post.writeTimeStamp;
  div.onclick = function() {
    editDraft(post.writeTimeStamp);
  };

  var isDraft = (post.state == 'draft');
  var wasDraft = !!document.querySelector('.drafts #' + div.id);
  var stateChange = !!(isDraft ^ wasDraft);
  div.className = 'savedPost';

  var content = trimContent(post.content);

  var contentDiv = document.createElement('div');
  contentDiv.className = 'contentDiv';

  // Don't look at this :(
  contentDiv.innerHTML = (error && "<div class='postError'>" + error + "</div>") +
                  (date && "<p class='postDate'>" + date + "</p>") +
                  (title && "<span class='postTitle'>" + title + "</span>") +

                  GPEditor.prototype.plusFormatToHtml(content, post.mentioned) +
                  renderReshareMeta(post);

  $(contentDiv.querySelectorAll('a')).attr({href: null});

  var mediaDiv = $('<div class="mediaDiv">' + postMedia + '</div>')[0];

  div.appendChild(contentDiv);
  div.appendChild(mediaDiv);

  var existing = document.getElementById(div.id);
  var column = $('#posts ' + (isDraft ? '.drafts' : '.scheduled') + ' .postsList');
  if (existing) {
    if (stateChange) {
      removeRemovedPosts([post]);
      addPostToColumn(div, column[0], !isDraft);
    } else {
      var existingMediaDiv = existing.querySelector('.mediaDiv');
      if (!existingMediaDiv) {
        existing.innerHTML = div.innerHTML;
      } else {
        existing.querySelector('.contentDiv').innerHTML = contentDiv.innerHTML;
        if (mediaDiv.innerHTML != existingMediaDiv.innerHTML) {
          existingMediaDiv.innerHTML = mediaDiv.innerHTML;
        }
      }
    }
  } else {
    addPostToColumn(div, column[0], !isDraft);
  }
}

function addPostToColumn(div, column, append) {
  if (lastUpdate == 0) {
    if (append) {
      $(div).appendTo($(column));
    } else {
      $(div).prependTo($(column));
    }
  } else {
    $(div).addClass('activity').hide().prependTo($(column)).show('fade', 200, function(){$(this).removeClass('activity')});
  }
}

function trimContent(string) {
  if (!string || !(string > '')) {
    return string;
  }
  var maxChars = 350;
  var trimmed = string.match(/(^[^\n]*\n[^\n]*\n[^\n]*\n[^\n]*\n)/);
  if (trimmed && trimmed[0]) {
    // Content has line breaks.
    return trimmed[0].replace(/[\n]+$/, '\n&hellip;');
  } else {
    if (string.length > maxChars + 40) {
      string = string.substring(0, maxChars).replace(/\s+$/, '') + '&hellip;';
    }
    return string;
  }
}

function renderMediaItems(medias) {
  var image = medias.images[0];
  var video = medias.video;
  var link = medias.link;

  return (link && link.title ?
      "<h3><a class='mediaLink' href='" + link.url + "'>" +
      link.title + "</a></h3>" : "") +

  (!link && image ? renderOtherMedia(medias) : '') +
  (link && image ? "<div id='mediaImage'><img src='" + image.url + "'></div>" : "") +

  (video ? "<div id='mediaVideo'><iframe src='" + video.embed + "' width='290' height='200' ></iframe></div>" : '') +

  (link && link.description ? "<div id='mediaDescription'>" + link.description + "</div>" : "") +
  "<div class='clearFix'></div>";
}

function renderOtherMedia(medias) {
  var image = medias.images[0];
  return "<div id='otherMediaImage'>" + (image ? "<img src='" + image.url + "'>" : '') + "</div>";
}

function renderLinkElements(medias) {
  var link = medias.link;
  if (!link) {
    console.error('Missing link');
    return '';
  }

  var chosenIndex = (medias.change && medias.change.chosenImageIndex) || 0;
  var removeDescription = !!(medias.change && medias.change.removeDescription);

  var result = "<h3 id='linkTitle'><a href='" + link.url + "'>" + link.title + "</a></h3>";

  if (medias.images[chosenIndex]) {
    var imagePicker = "<div id='imagePicker'>" +
        (medias.images.length > 1 ?
          "<span id='imagePickPrev'>&lt;</span>" +
          "<span id='imagePickNext'>&gt;</span>" : '') +
        "<span id='removeImage'>X</span></div>";
    result += "<div id='linkImage'>" +
        imagePicker +
        "<img src='" + medias.images[chosenIndex].url + "'></div>";
  }

  var video = medias.video;
  if (video) {
    result += "<div id='linkVideo'><iframe src='" + video.embed + "' width='290' height='200' ></iframe></div>";
  }

  if (link.description && !removeDescription) {
    result += "<div id='linkDescription'>" + link.description +
        "<br><span id='removeDescription'>Remove Description</span></div>";
  }

  result += "<div class='clearFix'></div>";
  return result;
}

function refresh() {
  addDraftEditBox();
  refreshPosts();
}

function showScheduleBar() {
  $('#scheduleBar').show();
}

var stopRefreshing;
function refreshPosts() {
  stopRefreshing = false;
  chrome.extension.sendRequest({'type': 'fetchAll'}, function(result) {
    if (stopRefreshing || result.lastUpdate == lastUpdate) {
      return;
    }
    result.posts && renderAllPosts(result.posts);
    lastUpdate = result.lastUpdate;
  });
}

function refreshIfNeeded() {
  if (!stopRefreshing) {
    refreshPosts();
  }
  window.setTimeout(refreshIfNeeded, 300);
}

function populateEditorMediaArea(medias) {
  var link = $('#link').val();
  var mediasLink = medias && medias.link && medias.link.url;
  function populate(html) {
    $('#postMedia').html(html);
    if (!$('#postMedia').is(':visible')) {
      $('#postMedia').show('blind', 500);
      $('#linkBar').hide('blind', 100);
    }
    $('#addLinkAction').attr({'class': 'loaded'});
  };
  if (link || mediasLink) {
    if (link == mediasLink) {
      populate(renderLinkElements(medias));
    } else {
      chrome.extension.sendRequest({type: 'getLinkMedia', link: link}, function(result) {
        if (result) {
          populate(renderLinkElements(result));
          currentMedias = result;
          needRefresh = true;
        }
      });
    }
  } else {
    if (medias && (medias.video || medias.images && medias.images.length)) {
      populate(renderOtherMedia(medias));
    } else {
      $('#postMedia').html('');
      $('#addLinkAction').attr({'class': 'enabled'});
    }
  }
}

function uncollapse(force) {
  if ($('#editbox').is('.collapsed') || force === true) {
    $('#title').attr({placeholder: 'Title (optional)'});
    $('#editbox').removeClass('collapsed');
    var pos = function() {
      $('#collapseEditbox').animate({opacity: 1}, 400);
    };
    if (force === true) {
      $('.hideWhenCollapsed').show();
      pos();
    } else {
      $('.hideWhenCollapsed').show('blind', 400, pos);
    }
    $('#posts').css({opacity: 0.7});
  }
}

function collapse(immediately) {
  if (!$('#editbox').is('.collapsed')) {
    $('#collapseEditbox').animate({opacity: 0}, 400);
    $('#postMedia').hide();
    $('#title').attr({placeholder: "Create new post..."});
    $('#editbox').addClass('collapsed');
    if (isEmptyPost(getEditedPost())) {
      delPost();
    } else {
      addDraftEditBox();
    }
    if (immediately === true) {
      $('.hideWhenCollapsed, #scheduleBar').hide();
    } else {
      $('.hideWhenCollapsed, #scheduleBar:visible').hide('blind', 400);
    }
    $('#posts').css({opacity: 1.0});
    // TODO: figure this out so I don't have to repeat myself.
    $('#editbox, #circleChooserBar, .buttonNotSchedule').css({opacity: 1});
    $('#buttonSchedule').text('schedule');
    $('#linkBar').hide();
    var sbutton = $('#buttonSchedule');
    sbutton.removeClass('opened');
    sbutton.addClass('closed');
    sbutton.data('active', null);
    resetDeleteButton();
    $('.gp-mention').remove();
  }
}

function animateButtonText(jButton, newText, duration) {
  jButton.css({color: 'rgba(255,255,255,0)', 'text-shadow': 'none'});
  window.setTimeout(function() {
    jButton.text(newText);
    jButton.css({color: ''});
    window.setTimeout(function(){
      jButton.css({'text-shadow': ''});
    }, duration);
  }, duration);
}

function resetDeleteButton() {
  var jDelete = $('#buttonDelete');
  jDelete.removeClass('confirm').text(jDelete.data('text'));
  var timeoutId = jDelete.data('timeoutId');
  if (timeoutId) {
    window.clearTimeout(timeoutId);
    jDelete.data('timeoutId', 0);
  }
}

function animateBlur(jElement, steps, interval, initial, stepSize) {
  if (steps) {
    if (initial > 0.05) {
      jElement.css({'-webkit-filter': 'blur(' + initial + 'px)'});
    } else {
      jElement.css({'-webkit-filter': ''});
    }
    window.setTimeout(function() {
      animateBlur(jElement, steps - 1, interval, initial + stepSize, stepSize);
    }, interval);
  }
};

function shiftChosenImage(n) {
  if (!currentMedias.change) {
    currentMedias.change = {chosenImageIndex: 0};
  }
  currentMedias.change.chosenImageIndex =
      (currentMedias.change.chosenImageIndex + currentMedias.images.length + n) %
        currentMedias.images.length;
  populateEditorMediaArea(currentMedias);
}

function changeTimeIfDraft() {
  var date = new Date($('#dateInput').val() + ' ' + $('#timeInput').val());
  if (date.toString() != 'Invalid Date' && document.querySelector('.drafts #post' + $('#write_time_stamp').val())) {
    $('#time').val(date.getTime());
  }
}

function setListeners() {
  $('#sendFeedback').position({my:'left top', at:'right top', of:'#appWrap'});
  $(window).resize(function() {
    $('#sendFeedback').position({my:'left top', at:'right top', of:'#appWrap'});
  });
  $('#addLink').delegate('.enabled', 'click', function() {
    $('#linkBar').show('blind', 200);
    $('#attachments').addClass('notempty');
    $(this).removeClass('enabled');
    $(this).addClass('disabled');
  });
  $('#addLink').delegate('.disabled', 'click', function() {
    $('#linkBar').hide('blind', 200);
    $('#attachments').removeClass('notempty');
    $(this).removeClass('disabled');
    $(this).addClass('enabled');
  });
  $('#addLink').delegate('.loaded', 'click', function() {
    // Remove Link
    $('#link, #linkInput').val('');
    currentMedias = undefined;
    $('#attachments').removeClass('notempty');
    $('#postMedia').hide('blind', 200, function(){$(this).html('');});
    $(this).removeClass('loaded');
    $(this).addClass('enabled');
    // Force autosave.
    post('autosave');
  });
  $('#submitLink').click(function() {
    $('#link').val($('#linkInput').val());
    $('#linkBar').hide('blind', 100);
    populateEditorMediaArea();
  });
  $('#linkInput').keydown(function(e) {
    if (e.keyCode == 13) {
      $('#submitLink').click();
    }
  });
  $('#buttonSchedule').click(function() {
    trackClick(this.id);
    var jself = $(this);
    var muteWhenScheduling = '#editbox, #circleChooserBar, .buttonNotSchedule';
    if (jself.data('active')) {
      $('#scheduleBar').hide('blind', 400);
      jself.removeClass('opened');
      jself.addClass('closed');
      jself.data('active', null);
      $(muteWhenScheduling).css({opacity: 1.0});
      animateButtonText(jself, 'schedule', 300);
    } else {
      $('#scheduleBar').show('blind', 200);
      jself.removeClass('closed');
      jself.addClass('opened');
      jself.data('active', true);
      $(muteWhenScheduling).css({opacity: 0.4});
      animateButtonText(jself, 'cancel', 400);
    }
  });
  $('#buttonDelete').click(function() {
    trackClick(this.id);
    if ($(this).is('.confirm')) {
      trackClick(this.id + 'Confirm');
      delPost();
      collapse();
      resetDeleteButton();
    } else {
      trackClick(this.id + 'First');
      var duration = 200;
      $(this).data('text', $(this).text())
        .slideUp(duration, function() {
          $(this).text('are you sure?')
            .addClass('confirm')
            .slideDown(duration);
        });
      var self = this;
      $(this).data('timeoutId', window.setTimeout(function() {
        $(self).slideUp(duration, function() {
          $(self).text($(self).data('text'))
              .removeClass('confirm')
              .slideDown(duration);
        });
      }, 10000));
    }
  });
  $('#buttonDraft').click(function() {
    trackClick(this.id);
    post('draft');
    collapse();
  });
  $('#buttonScheduleStepTwo').click(function() {
    trackClick(this.id);
    if (localStorage['iUnderstand'] == "1") {
      var timeInput = $('#timeInput').val();
      var date = new Date($('#dateInput').val() + ' ' + timeInput);
      var jself = $(this);
      if (date.toString() == 'Invalid Date') {
        animateButtonText(jself, 'invalid time', 300);
        $('#dateInput').timepicker('show');
        window.setTimeout(function() {
          animateButtonText(jself, 'schedule', 300);
        }, 5000);
        return;
      }
      if (date < new Date()) {
        animateButtonText(jself, 'time too early', 300);
        $('#timeInput').timepicker('show');
        window.setTimeout(function() {
          animateButtonText(jself, 'schedule', 300);
        }, 5000);
      } else {
        $('#time').val(date.getTime());
        post('scheduled');
        collapse();
      }
    } else {
      animateBlur($('#appWrap, #sendFeedback'), 5, 200, 0, 0.4);
      $('#information').fadeIn(1000);
    }
  });
  $('#iUnderstand').click(function() {
    trackClick(this.id);
    animateBlur($('#appWrap, #sendFeedback'), 5, 200, 1.6, -0.4);
    $('#information').fadeOut(1000);
    localStorage['iUnderstand'] = '1';
    $('#buttonScheduleStepTwo').click();
  });
  $('#buttonPost').click(function() {
    trackClick(this.id);
    post('post');
    collapse();
  });
  $('#editbox').keyup(function() {
    needRefresh = true;
  });
  $('input:not(#linkInput)').change(function(e) {
    needRefresh = true;
  });
  $('#sendFeedback').click(function(e) {
    trackClick(this.id);
    e.stopPropagation();
    needRefresh = true;
    autosave();
    collapse();
    window.setTimeout(function() {
      addDraftEditBox({
        title: 'Do Share Feedback',
        content: '\n\n#DoShareFeedback #DoShare\n\n_(CC @115470071077898720170)_',
        entities: [{personId: '115470071077898720170', name: 'Tzafrir Rehan'}],
        mentioned: {'115470071077898720170': 'Tzafrir Rehan'}
      });
      uncollapse();
      $('[contenteditable]').focus();
    }, 200);
  });
  $('#circleChooser')
      .keydown(function(e) {
        if (e.keyCode == $.ui.keyCode.TAB) {
          console.log('ok')
          e.stopImmediatePropagation();
        }
      })
      .autocomplete({
    minLength: 0,
    appendTo: $('#circleChooserBar'),
    position: {
      of: $('#circleChooserBar')
    },
    focus: function(){},
    autoFocus: true,
    open: function() {
      $('.ui-autocomplete').css('width', 'inherit');
      $('#closeCircleChooser')
          .css({opacity: 1});
    },
    close: function() {
      $('#closeCircleChooser').css({opacity: 0});
    },
    select: function(event, ui) {
      needRefresh = true;
      audienceChooser.addEntity(ui.item);
      $('#circleChooser').autocomplete('search', '');
    },
    source: function(request, callback) {
      chrome.extension.sendRequest({type: 'getCircles'}, function(circles) {
        var matchingCircles = [
          {
            name: 'Public',
            circleId: 'PUBLIC',
            photoUrl: 'img/icon_public.png'
          },
          {
            name: 'Extended Circles',
            circleId: 'EXTENDED_CIRCLES',
            photoUrl: 'img/icon_extended.png'
          },
          {
            name: 'Your Circles',
            circleId: 'YOUR_CIRCLES',
            photoUrl: 'img/icon_circles.png'
          }
        ].concat(circles.filter(function(circle) {
          return !(circle.id == '15' || circle.name == 'Blocked');
        })).filter(function(circle) {
          return !!circle.name.toLowerCase().match(request.term.toLowerCase());
        }).map(function(circle) {
          return {
            name: circle.name,
            circleId: circle.circleId || circle.id,
            photoUrl: circle.photoUrl || 'img/icon_circle.png'
          };
        }).filter(function(circle) {
          // Drop circles that are already chosen.
          return !document.querySelector('.c_' + circle.circleId);
        });
        callback(matchingCircles);
        if (request.term.length > 0) {
          chrome.extension.sendRequest({type: 'profileAutocomplete', prefix: request.term}, function(profiles) {
            profiles.forEach(function(profileResult) {
              profileResult.personId = profileResult.id;
            });
            callback(matchingCircles.concat(profiles));
          });
        }
      });
    }
  }).focus(function() {
    if (!($('.ui-autocomplete').is(':visible'))) {
      $('#circleChooser').autocomplete('search');
    }
  }).keydown(function(event) {
    var KEY = {
      BACKSPACE: 8
    };
    var k = event.keyCode;
    if (k == KEY.BACKSPACE && !$(this).val()) {
      audienceChooser.removeLastEntity();
    }
  }).data('autocomplete')._renderItem = function(ul, item) {
    return $('<li></li>')
      .data('item.autocomplete', item)
      .append('<a><span class="entityPhoto">' + (item.photoUrl ? '<img src="' + item.photoUrl + '" /' + '>' : '') +
          '</span>' +  item.name + '</a>')
      .appendTo(ul);
  };
  $('#circleChooserBar')
      .delegate('#circleChooserBar *', 'click', function(e){e.stopPropagation();})
      .click(function() {$('#circleChooser').focus()});
  $('#title').focus(uncollapse);
  $('#collapseEditbox').click(function() {
    collapse();
    trackClick(this.id);
  });
  {
    $('#bodyWrap').click(function(e){
      trackClick('sidebarClose');
      collapse();
    });
    $('#appWrap').click(function(e){
      // Block the event from reaching bodyWrap's handler.
      e.stopPropagation();
    });
  }
  $('#dateInput').datepicker({
    beforeShow: function(t, inst) {
      if (!$('#dateInput').val()) {
        $('#dateInput').datepicker('setDate', (new Date()));
      }
      window.setTimeout(function() {
        inst.dpDiv.position({
          my: 'center top',
          at: 'center bottom',
          of: '#dateInput',
          collision: 'none'
        });
      }, 1);
    },
    onSelect: changeTimeIfDraft,
    dayNamesMin: ['S', 'M', 'T', 'W', 'T', 'F', 'S'],
    minDate: 0,
    showButtonPanel: true,
    showOtherMonths: true,
		selectOtherMonths: true
  });
  $('#timeInput').timepicker({
    currentText: '',
    beforeShow: function(t, inst) {
      if (!$('#timeInput').val()) {
        $('#timeInput').timepicker('setDate', (new Date()));
      }
      window.setTimeout(function() {
        inst.dpDiv.position({
          my: 'center top',
          at: 'center bottom',
          of: '#timeInput',
          collision: 'none'
        });
      }, 1);
    },
    onSelect: changeTimeIfDraft,
  });
  $('#attachments').delegate('#imagePickPrev', 'click', function() {
    shiftChosenImage(-1);
  });
  $('#attachments').delegate('#imagePickNext', 'click', function() {
    shiftChosenImage(1);
  });
  $('#attachments').delegate('#removeImage', 'click', function() {
    if (!currentMedias.change) {
      currentMedias.change = {};
    }
    currentMedias.change.chosenImageIndex = -1;
    populateEditorMediaArea(currentMedias);
  });
  $('#attachments').delegate('#removeDescription', 'click', function() {
    if (!currentMedias.change) {
      currentMedias.change = {};
    }
    currentMedias.change.removeDescription = true;
    populateEditorMediaArea(currentMedias);
  });
  $('footer a').click(function() {
    trackClick('profile' + this.innerText.replace(' ', ''));
  });
  $('#closeCircleChooser').click(function() {
    trackClick(this.id);
  });
  $('#addPhoto').click(function() {
    chrome.permissions.request({
      origins: ['https://picasaweb.google.com/', 'https://www.google.com/']
    }, function(granted) {
      if (granted) {
        chrome.extension.sendRequest({type: 'oauthAuthenticate'}, function(oauth) {
          console.log('authed', oauth);
        });
      }
    });
  });
}

function autosave() {
  if (!needRefresh) {
    return;
  }
  needRefresh = false;
  var currentPost = getEditedPost('', 0);
  if (isEmptyPost(currentPost)) {
    return;
  }
  post('autosave');
}

/**
 * Entity {
 *   circleId OR personId
 *   name
 * }
 */
function AudienceChooser(entities) {
  this._entities = entities || [];
  this._chooser = $('#circleChooser');
  this.updateChooser();
}

AudienceChooser.prototype.updateChooser = function() {
  $('.audienceChooserEntity').remove();
  var self = this;
  $(this._entities.map(function(entity) {
    return $('<div class="audienceChooserEntity ' +
        (entity.circleId ? 'c_' + entity.circleId : 'p_' + entity.personId) + '">' +
        entity.name + '</div>').append(
          $('<span>x</span>')
              .addClass('deleteEntityButton')
              .click(function() {self.removeEntity(entity)})
        )[0];
  })).prependTo($('#circleChooserBar'));
}

AudienceChooser.prototype.getEntities = function() {
  return this._entities;
}

AudienceChooser.prototype.addEntity = function(entity) {
  if (!entity) {
    return;
  }
  this._entities.push(entity);
  this.updateChooser();
}

AudienceChooser.prototype.removeEntity = function(entity) {
  this._entities = this._entities.filter(function(e) {
    return e != entity;
  });
  this.updateChooser();
}

AudienceChooser.prototype.removeLastEntity = function() {
  this._entities.pop();
  this.updateChooser();
}

function onLoad() {
  var savedPostJson = localStorage['_tmp_post'];
  var savedPost;
  if (savedPostJson) {
    savedPost = JSON.parse(savedPostJson);
    mem[savedPost.writeTimeStamp] = savedPost;
  }
  localStorage.removeItem('_tmp_post');
  setListeners();
  addDraftEditBox(savedPost);
  refreshIfNeeded();
  window.setInterval(function() {
    autosave();
  }, 400);
  if (savedPostJson) {
    uncollapse(true);
  } else {
    collapse(true);
  }
  (function() {
   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   ga.src = 'https://ssl.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
}

  </script>
</head>
<body onload="onLoad()">
<script>
if (navigator.userAgent.match('Windows')) {
  document.body.className = document.body.className + ' windows';
}
</script>
  <div id="bodyWrap">
  <div id="appWrap">
    <div id="top">
      <header><h1><img src="img/logo.png" /></h1></header>
    </div>
    <div id="collapseEditbox"></div>
    <div id="writingArea">
      <div id="editbox">
        <div class="titleBar"><input id="title" autocomplete="off" /></div>
        <div class="hideWhenCollapsed">
          <div id="content" class="editbox"></div>
          <div id="postActions">
            <div class="postAction" id="addLink"><span id="addLinkAction" class="enabled"></span></div>
            <div class="postAction" id="addPhoto"></div>
          </div>
          <div id="attachments">
            <div id="reshare"></div>
            <div id="linkBar">
              <input id="linkInput" placeholder="link" />
              <button id="submitLink">add url</button>
            </div>
            <div id="postMedia"></div>
          </div>
        </div>
        <input type="hidden" id="link" />
        <input type="hidden" id="time" />
        <input type="hidden" id="image_id" />
        <input type="hidden" id="share_id" />
        <input type="hidden" id="write_time_stamp" />
      </div>
      <div id="barContainer" class="hideWhenCollapsed">
        <div id="circleChooserBar">
          <input id="circleChooser" placeholder="+ Add more people&hellip;">
          <div id="closeCircleChooser"></div>
        </div>
        <div id="buttonBar">
          <div><button id="buttonDelete" class="buttonNotSchedule">delete post :(</button></div>
          <div><button id="buttonDraft" class="buttonNotSchedule">send to drafts</button></div>
          <div><button id="buttonSchedule" class="closed">schedule</button></div>
          <div><button id="buttonPost" class="buttonNotSchedule">share now</button></div>
        </div>
      </div>
      <div class="clearFix"></div>
      <div id="scheduleBar">
        <p>
          Share on <input id="dateInput" placeholder="mm/dd/yyyy" />
          at <input id="timeInput" placeholder="HH:MM" />
          <button id="buttonScheduleStepTwo">schedule</button>
        </p>
      </div>
    </div>
    <div id="posts">
      <div class="column drafts">
        <div class="columnHead">drafts</div>
        <div class="postsList"></div>
      </div>
      <div class="column scheduled">
        <div class="columnHead">scheduled</div>
        <div class="postsList"></div>
      </div>
    </div>
  </div>
    <footer>
      Created by <a href="https://plus.google.com/115470071077898720170/">Tzafrir Rehan</a>.
      Designed by <a href="https://twitter.com/joeltwits">Joel Califa</a>.
    </footer>
  </div>
  <div id="sendFeedback">send feedback</div>
  <div id="information" style="display: none">
    <h2>IMMA LET YOU FINISH SCHEDULING, BUT</h2>
    <p>Do Share is a <span>Chrome application<span> that runs <span><strong>only on your computer</strong></span>.<br>
    Posts are saved <span>in your browser</span>, and are <span>sent to Google+</span> at the <span>scheduled time.</span></p>
    <p>Scheduled posts will be successfully sent to Google+ if <span>Chrome is running</span>, and <span>logged into Google+ at that time.</span></p>
    <button id="iUnderstand">I got this. Chrome has to be running and connected to the internet, for Do Share to be able to send posts to Google+.<br><br><span class="iUnderstand">I understand!</span></button>
  </div>
