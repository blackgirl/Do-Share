<!doctype html>
<head>
  <meta charset="utf-8">
  <title>Night Watch</title>
  <!-- TODO: Need icon -->
  <link rel="icon" href="icon128.png" />
  <link rel="stylesheet" href="roboto/roboto.css" />
  <link rel="stylesheet" href="style.css" />

<script src="opera_wysiwyg/utils.js"></script>
<script src="opera_wysiwyg/editor.js"></script>
<script src="opera_wysiwyg/editlib.js"></script>
<script src="gp_editor.js"></script>

<script src="libs/jquery-1.7.1.min.js"></script>
<script src="libs/jquery-ui-1.8.18.custom.min.js"></script>
<link rel="stylesheet" type="text/css" href="jqueryui_css/ui-lightness/jquery-ui-1.8.18.custom.css">

<script>
var PUBLIC_ENTITY = {
  name: 'Public',
  circleId: 'PUBLIC'
};

var mem = {};
var touch = {};
var needRefresh = false;
var gpe;
var audienceChooser;

var postsCurrentlyDisplayed = [];

var lastUpdate = 0;

function val(name) {
  var $ = document.getElementById(name).value;
  return ($ ? $ : undefined);
}

function parseTimeField() {
  $('#timeParsed').text(new Date(val('timeInput')).toString());
}

function sendPost(post) {
  if (post.state == 'autosave') {
    post.state = post.timeStamp ? 'scheduled' : 'draft';
    chrome.extension.sendRequest({'type': 'post', 'post': post}, refreshPosts);
    $('#write_time_stamp').val(post.writeTimeStamp);
  } else {
    chrome.extension.sendRequest({'type': 'post', 'post': post}, refresh);
  }
}

function getEditedPost(state, writeTimeStamp) {
  return {
    'state': state,
    'content': getContent() || '',
    'share_id': val('share_id'),
    'reshare': (mem[writeTimeStamp] && mem[writeTimeStamp].reshare) || undefined,
    'image_id': val('image_id'),
    'title': val('title'),
    'entities': audienceChooser.getEntities(),
    'timeStamp': new Date(val('time')).getTime() || undefined,
    'link': val('link') || undefined,
    'touch': new Date().getTime()
  };
}

function isEmptyPost(post) {
  for (var key in post) {
    if (key == 'entities' && post[key]) {
      // If the user entered only a few items, consider the post empty.
      if (post[key].length > 3) {
        return false;
      }
    } else if (post[key] && key != 'touch') {
      return false;
    }
  }
  return true;
}

function post(state) {
  var writeTimeStamp = Number(val('write_time_stamp') || 0);
  var post = getEditedPost(state, writeTimeStamp);
  if (writeTimeStamp) {
    post.writeTimeStamp = writeTimeStamp;
    var savedPost = mem[writeTimeStamp];
    if (savedPost) {
      post.reshare = savedPost.reshare;
    }
  } else {
    post.writeTimeStamp = new Date().getTime();
  }
  sendPost(post);
  if (state != 'autosave') {
    blinkPost(writeTimeStamp);
  }
}

function blinkPost(writeTimeStamp) {
  var post = $('#post' + writeTimeStamp);
  post.addClass('activity');
  window.setTimeout(function(){post.removeClass('activity')}, 400);
}

function delPost() {
  var writeTimeStamp = Number(val('write_time_stamp'));
  if (document.getElementById('post' + writeTimeStamp)) {
    chrome.extension.sendRequest({'type': 'delPost', 'writeTimeStamp': writeTimeStamp}, refresh);
  } else {
    refresh();
  }
}

function getDateString(post) {
  if (post.state == 'scheduled') {
    return "Will be posted on " + new Date(post.timeStamp).toString();
  } else {
    return '';
  }
}

function publishDraft(writeTimeStamp) {
  chrome.extension.sendRequest({'type': 'publishDraft', 'writeTimeStamp': writeTimeStamp},
      function(ok) {
    if (ok) {
      var draftDiv = document.getElementById('post' + writeTimeStamp);
      draftDiv.parentElement.removeChild(draftDiv);
    }
  });
}

function getContent() {
  return gpe && gpe.getText();
}

function profileAutocompleter(prefix, callback) {
  chrome.extension.sendRequest({type: 'profileAutocomplete', prefix: prefix}, callback);
}

function addDraftEditBox(post) {
  if (!post) {
    post = {
      entities: [PUBLIC_ENTITY]
    };
  }
  var writeTimeStamp = post.writeTimeStamp || '';
  var content = post.content || '';
  var share_id = post.share_id || '';
  var link = (!post.reshare && post.link) || '';
  var image_id = post.image_id || '';
  var title = post.title || '';
  var time = post.timeStamp ? new Date(post.timeStamp).toString() : '';
  var entities = post.entities || [];
  var medias = post.medias;
  if (medias) {
    link = medias.link && medias.link.url || '';
  }

  $('#title').val(title);
  $('#share_id').val(share_id);
  $('#link').val(link);
  $('#image_id').val(image_id);
  $('#time').val(time);
  $('#timeInput').val(time);
  $('#write_time_stamp').val(writeTimeStamp);

  audienceChooser = new AudienceChooser(entities);

  if (post.reshare) {
    $('#reshare').html(renderReshare(post));
    $('#addLinkAction').attr({'class': 'invalid'});
  } else {
    $('#reshare').html('');
    $('#addLinkAction').attr({'class': 'enabled'});
    populateEditorMediaArea(post.medias);
  }

  if (gpe) {
    gpe.destroy();
  }
  gpe = new GPEditor(document.getElementById('content'),
      content, writeTimeStamp, profileAutocompleter);
}

function renderReshare(post) {
  if (!(post && post.reshare)) {
    return '';
  }
  var rs = post.reshare;
  return '<div class="reshare"><h2>' + rs.author_name + ' originally shared this ' +
         '<a href="' + rs.url + '">post</a> ' +
         (rs.via_name ? ' (via ' + rs.via_name + ')' : '') +
         ':</h2>' +
         '<p>' + rs.content.replace(/(class=\'ot-hashtag\' href=\')/g, "$1https://plus.google.com/") + '</p>' +
         (rs.medias ? renderMediaItems(rs.medias) : '') + "</div>";
}

function renderReshareMeta(post) {
  if (!(post && post.reshare)) {
    return '';
  }
  var rs = post.reshare;
  return '<span class="reshareMeta">Reshared post by ' + rs.author_name + '</span>';
}

function editDraft(writeTimeStamp) {
  chrome.extension.sendRequest({type: 'fetchPost', writeTimeStamp: writeTimeStamp},
      function(post) {
    $('body').animate({scrollTop: 0}, 450);
    stopRefreshing = true;
    mem[post.writeTimeStamp] = post;
    addDraftEditBox(post);
    uncollapse();
  });
}

function bMinusA(a, b, key) {
  var aKeys = a.map(function(item){return item[key]});
  return b.filter(function(item) {
    return aKeys.indexOf(item[key]) == -1;
  });
}

function removeRemovedPosts(removedPosts) {
  removedPosts.forEach(function(post) {
    var p = $('#post' + post.writeTimeStamp);
    var interval = 1000;
    p.hide('blind', {}, interval);
    window.setTimeout(function() {
      p.remove();
    }, interval + 10);
  });
}

function getImgHtml(post) {
  function getMediaHtml(items) {
    var image = items.images[0];
    var video = items.video;
    if (video) {
      return "<iframe src='" + video.embed + "' width='260' ></iframe>";
    }
    if (image) {
      return "<img width='260' src='" + image.url + "' /" + ">";
    }
  };
  if (post.reshare && post.reshare.medias) {
    return getMediaHtml(post.reshare.medias);
  } else if (post.medias) {
    return getMediaHtml(post.medias);
  }
}

function renderAllPosts(posts) {
  if (!posts instanceof Array) {
    return;
  }
  var removedPosts = bMinusA(posts, postsCurrentlyDisplayed, 'writeTimeStamp');
  postsCurrentlyDisplayed = posts;
  removeRemovedPosts(removedPosts);
  posts.forEach(function(post) {
    renderPost(post);
  });
}

function renderPost(post) {
  if (post.touch && post.touch == touch[post.writeTimeStamp]) {
    return;
  }
  touch[post.writeTimeStamp] = post.touch;
  var div = document.createElement('div');
  var date = getDateString(post);
  var title = post.title || '';

  var attachmentHTML = '';
  var postImage = getImgHtml(post) || '';

  div.id = 'post' + post.writeTimeStamp;
  div.onclick = function() {
    editDraft(post.writeTimeStamp);
  };

  var isDraft = (post.state == 'draft');
  var wasDraft = !!document.querySelector('.drafts #' + div.id);
  var stateChange = !!(isDraft ^ wasDraft);
  div.className = 'savedPost';

  var content = trimContent(post.content);

  // Don't look at this :(
  div.innerHTML = (date && "<p class='postDate'>" + date + "</p>") +
                  (title && "<span class='postTitle'>" + title + "</span>") +

                  GPEditor.prototype.plusFormatToHtml(content) +
                  renderReshareMeta(post) +
                  "<br>" + postImage;

  var existing = document.getElementById(div.id);
  var column = $('#posts ' + (isDraft ? '.drafts' : '.scheduled') + ' .postsList');
  if (existing) {
    if (stateChange) {
      removeRemovedPosts([post]);
      addPostToColumn(div, column[0]);
    } else {
      existing.innerHTML = div.innerHTML;
    }
  } else {
    addPostToColumn(div, column[0]);
  }
}

function addPostToColumn(div, column) {
  if (lastUpdate == 0) {
    $(column).prepend(div);
  } else {
    $(div).addClass('activity').hide().prependTo($(column))
        .show('fade', 200, function(){$(this).removeClass('activity')});
  }
}

function trimContent(string) {
  if (!string || !(string > '')) {
    return string;
  }
  var maxChars = 350;
  var trimmed = string.match(/(^[^\n]*\n[^\n]*\n[^\n]*\n[^\n]*\n)/);
  if (trimmed && trimmed[0]) {
    // Content has line breaks.
    return trimmed[0].replace(/[\n]+$/, '\n&hellip;');
  } else {
    if (string.length > maxChars + 40) {
      string = string.substring(0, maxChars).replace(/\s+$/, '') + '&hellip;';
    }
    return string;
  }
}

function renderMediaItems(medias) {
  // TODO: Scroll through images.
  var image = medias.images[0];
  var video = medias.video;
  var link = medias.link;

  return (link && link.title ?
      "<a href='" + link.url +"'>" +
      "<h3>" + link.title + "</h3></a>" : "") +

  (image ? "<img src='" + image.url + "'><br>" : "") +

  (video ? "<iframe src='" + video.embed + "' width='" + video.w / 2 +
      "' height='" + video.h / 2 + "' ></iframe>" : '') +

  (link && link.description ? "<p>" + link.description + "</p>" : "");
}

function refresh() {
  addDraftEditBox();
  refreshPosts();
}

function showScheduleBar() {
  $('#scheduleBar').show();
}

var stopRefreshing;
function refreshPosts() {
  stopRefreshing = false;
  chrome.extension.sendRequest({'type': 'fetchAll'}, function(result) {
    if (stopRefreshing || result.lastUpdate == lastUpdate) {
      return;
    }
    result.posts && renderAllPosts(result.posts);
    lastUpdate = result.lastUpdate;
  });
}

function refreshIfNeeded() {
  if (!stopRefreshing) {
    refreshPosts();
  }
  window.setTimeout(refreshIfNeeded, 300);
}

function populateEditorMediaArea(medias) {
  var link = $('#link').val();
  var mediasLink = medias && medias.link && medias.link.url;
  function renderMedias(medias) {
    $('#postMedia').html(renderMediaItems(medias))
        .show('blind', 500);
    $('#linkBar').hide('blind', 100);
    $('#addLinkAction').attr({'class': 'invalid'});
  };
  if (link || mediasLink) {
    if (link == mediasLink) {
      renderMedias(medias);
    } else {
      chrome.extension.sendRequest({type: 'getLinkMedia', link: link}, function(result) {
        if (result) {
          renderMedias(result);
        }
      });
    }
  } else {
    if (medias && (medias.video || medias.images && medias.images.length)) {
      renderMedias(medias);
    } else {
      $('#postMedia').hide('blind', 500, function(){$(this).html('')});
      $('#addLinkAction').attr({'class': 'enabled'});
    }
  }
}

function uncollapse(force) {
  if ($('#editbox').is('.collapsed') || force === true) {
    $('#title').attr({placeholder: 'Title (optional)'});
    $('#editbox').removeClass('collapsed');
    var pos = function() {
      $('#collapseEditbox').position({
        my: 'right bottom',
        at: 'right top',
        of: '.titleBar',
        offset: '-6 -6',
        collision: 'none'
      }).show(100);
    };
    if (force === true) {
      $('.hideWhenCollapsed').show();
      pos();
    } else {
      $('.hideWhenCollapsed').show('blind', 400, pos);
    }
    $('#posts').css({opacity: 0.7});
  }
}

function collapse(immediately) {
  if (!$('#editbox').is('.collapsed')) {
    $('#collapseEditbox').hide();
    $('#title').attr({placeholder: "Create new post..."});
    $('#editbox').addClass('collapsed');
    addDraftEditBox();
    if (immediately === true) {
      $('.hideWhenCollapsed, #scheduleBar').hide();
    } else {
      $('.hideWhenCollapsed, #scheduleBar:visible').hide('blind', 400);
    }
    $('#posts').css({opacity: 1.0});
    $('#editbox, .hideWhenCollapsed').css({opacity: 1});
    var sbutton = $('#buttonSchedule');
    sbutton.removeClass('opened');
    sbutton.addClass('closed');
    sbutton.data('active', null);
  }
}

function setListeners() {
  $('#sendFeedback').position({my:'left top', at:'right top', of:'#appWrap'});
  $(window).resize(function() {
    $('#sendFeedback').position({my:'left top', at:'right top', of:'#appWrap'});
  });
  $('#addLink').delegate('.enabled', 'click', function() {
    $('#linkBar').show('blind', 200);
    $(this).removeClass('enabled');
    $(this).addClass('disabled');
  });
  $('#addLink').delegate('.disabled', 'click', function() {
    $('#linkBar').hide('blind', 200);
    $(this).removeClass('disabled');
    $(this).addClass('enabled');
  });
  $('#closeLinkBar').click(function() {
    $('#addLink').children().click();
  });
  $('#submitLink').click(function() {
    $('#link').val($('#linkInput').val());
    $('#addLink').children().click();
    populateEditorMediaArea();
  });
  $('#linkInput').keydown(function(e) {
    if (e.keyCode == 13) {
      $('#submitLink').click();
    }
  });
  $('#buttonSchedule').click(function() {
    var jself = $(this);
    if (jself.data('active')) {
      $('#scheduleBar').hide('blind', 400);
      jself.removeClass('opened');
      jself.addClass('closed');
      jself.data('active', null);
      $('#editbox, .hideWhenCollapsed').css({opacity: 1.0});
    } else {
      $('#scheduleBar').show('blind', 200);
      jself.removeClass('closed');
      jself.addClass('opened');
      jself.data('active', true);
      $('#editbox, .hideWhenCollapsed').css({opacity: 0.1});
    }
  });
  $('#closeScheduleBar').click(function() {
    $('#buttonSchedule').click();
  });
  $('#buttonDelete').click(function() {
    delPost();
    collapse();
  });
  $('#buttonDraft').click(function() {
    post('draft');
    collapse();
  });
  $('#buttonScheduleStepTwo').click(function() {
    var time = $('#timeInput').val();
    if (new Date(time) < new Date()) {
      alert('Time too early (TODO: ERROR)');
    } else {
      $('#time').val(time);
      post('scheduled');
      $('#buttonSchedule').click();
    }
    collapse();
  });
  $('#buttonPost').click(function() {
    post('post');
    collapse();
  });
  $('#editbox').keyup(function() {
    needRefresh = true;
  });
  $('input').change(function() {
    needRefresh = true;
  });
  $('#sendFeedback').click(function() {
    needRefresh = true;
    autosave();
    window.setTimeout(function() {
      addDraftEditBox({
        title: 'Do Share Feedback',
        content: '\n\n#DoShareFeedback #DoShare\n\n_(CC @115470071077898720170)_',
        entities: []
      });
      uncollapse();
      $('[contenteditable]').focus();
    }, 200);
  });
  $('#circleChooser').autocomplete({
    minLength: 0,
    appendTo: $('#circleChooserBar'),
    position: {
      of: $('#circleChooserBar')
    },
    focus: function(){},
    open: function() {
      $('.ui-autocomplete').css('width', 'inherit');
    },
    select: function(event, ui) {
      needRefresh = true;
      audienceChooser.addEntity(ui.item);
    },
    source: function(request, callback) {
      chrome.extension.sendRequest({type: 'getCircles'}, function(circles) {
        var matchingCircles = [
          PUBLIC_ENTITY,
          {
            name: 'Extended Circles',
            circleId: 'EXTENDED_CIRCLES'
          },
          {
            name: 'Your Circles',
            circleId: 'YOUR CIRCLES'
          }
        ].concat(circles.filter(function(circle) {
          return !(circle.id == '15' || circle.name == 'Blocked');
        })).filter(function(circle) {
          return !!circle.name.toLowerCase().match(request.term.toLowerCase());
        }).map(function(circle) {
          return {
            name: circle.name,
            circleId: circle.circleId || circle.id
          };
        });
        callback(matchingCircles);
        if (request.term.length > 0) {
          chrome.extension.sendRequest({type: 'profileAutocomplete', prefix: request.term}, function(profiles) {
            profiles.forEach(function(profileResult) {
              profileResult.personId = profileResult.id;
            });
            callback(matchingCircles.concat(profiles));
          });
        }
      });
    }
  }).focus(function() {
    if (!($('.ui-autocomplete').is(':visible'))) {
      $('#circleChooser').autocomplete('search');
    }
  }).data('autocomplete')._renderItem = function(ul, item) {
    return $('<li></li>')
      .data('item.autocomplete', item)
      .append('<a><span class="entityPhoto">' + (item.photoUrl ? '<img src="' + item.photoUrl + '" /' + '>' : '') +
          '</span>' +  item.name + '</a>')
      .appendTo(ul);
  };
  $('#attachments').on('DOMSubtreeModified', function() {
    if ($(this).height() > 0) {
      $(this).addClass('notempty');
    } else {
      $(this).removeClass('notempty');
    }
  });
  $('#title').focus(uncollapse);
  $('#collapseEditbox').click(collapse);
  $(document).click(function(e){
    collapse();
  });
  $('#writingArea').click(function(e){
    // Block the event from reaching document's handler.
    e.stopPropagation();
  }).on('blur', '*', function() {
    if (isEmptyPost(getEditedPost())) {
      delPost();
    }
  });
}

function autosave() {
  if (!needRefresh) {
    return;
  }
  needRefresh = false;
  var currentPost = getEditedPost('', 0);
  post('autosave');
}

/**
 * Entity {
 *   circleId OR personId
 *   name
 * }
 */
function AudienceChooser(entities) {
  this._entities = entities || [];
  this._chooser = $('#circleChooser');
  this.updateChooser();
}

AudienceChooser.prototype.updateChooser = function() {
  $('.audienceChooserEntity').remove();
  var self = this;
  $(this._entities.map(function(entity) {
    return $('<div class="audienceChooserEntity ' +
        (entity.circleId ? 'c_' + entity.circleId : 'p_' + entity.personId) + '">' +
        entity.name + '</div>').append(
          $('<span>x</span>')
              .addClass('deleteEntityButton')
              .click(function() {self.removeEntity(entity)})
        )[0];
  })).prependTo($('#circleChooserBar'));
}

AudienceChooser.prototype.getEntities = function() {
  return this._entities;
}

AudienceChooser.prototype.addEntity = function(entity) {
  if (!entity) {
    return;
  }
  this._entities.push(entity);
  this.updateChooser();
}

AudienceChooser.prototype.removeEntity = function(entity) {
  this._entities = this._entities.filter(function(e) {
    return e != entity;
  });
  this.updateChooser();
}

function onLoad() {
  var savedPostJson = localStorage['_tmp_post'];
  var savedPost;
  if (savedPostJson) {
    savedPost = JSON.parse(savedPostJson);
    mem[savedPost.writeTimeStamp] = savedPost;
  }
  localStorage.removeItem('_tmp_post');
  addDraftEditBox(savedPost);
  setListeners();
  refreshIfNeeded();
  window.setInterval(function() {
    autosave();
  }, 400);
  if (savedPostJson) {
    uncollapse(true);
  } else {
    collapse(true);
  }
}

  </script>
</head>
<body onload="onLoad()">
  <div id="appWrap">
    <div id="top">
      <header><h1><img src="img/logo.png" /></h1></header>
    </div>
    <div id="writingArea">
      <div id="editbox">
        <div class="titleBar"><input id="title" autocomplete="off" /></div>
        <div class="hideWhenCollapsed">
          <div id="content" class="editbox"></div>
          <div id="postActions">
            <div class="postAction" id="addLink"><span id="addLinkAction" class="enabled">U</span></div>
          </div>
          <div id="attachments">
            <div id="reshare"></div>
            <div id="linkBar">
              <input id="linkInput" placeholder="link" />
              <button id="submitLink">Add</button>
              <div id="closeLinkBar" class="xButton">x</div>
            </div>
            <div id="postMedia"></div>
          </div>
        </div>
        <input type="hidden" id="link" />
        <input type="hidden" id="time" />
        <input type="hidden" id="image_id" />
        <input type="hidden" id="share_id" />
        <input type="hidden" id="write_time_stamp" />
      </div>
      <div class="hideWhenCollapsed">
        <div id="circleChooserBar">
          <input id="circleChooser" placeholder="+ Add more people&hellip;">
        </div>
        <div id="buttonBar">
          <div><button id="buttonDelete">delete post :(</button></div>
          <div><button id="buttonDraft">save draft</button></div>
          <div><button id="buttonSchedule" class="closed">schedule</button></div>
          <div><button id="buttonPost">share now</button></div>
        </div>
      </div>
      <div id="scheduleBar">
        <div id="closeScheduleBar" class="xButton">x</div>
        <p><input id="timeInput" placeholder="Time" /><button onclick="parseTimeField()">Parse</button></p>
        <p id="timeParsed"></p>
        <button id="buttonScheduleStepTwo">schedule</button>
      </div>
    </div>
    <div id="posts">
      <div class="column drafts">
        <div class="columnHead">drafts</div>
        <div class="postsList"></div>
      </div>
      <div class="column scheduled">
        <div class="columnHead">scheduled</div>
        <div class="postsList"></div>
      </div>
    </div>
  </div>
  <div id="sendFeedback">send feedback!</div>
  <div id="collapseEditbox"></div>
