<!doctype html>
<head>
  <meta charset="utf-8">
  <title>Night Watch</title>
  <!-- TODO: Need icon -->
  <link rel="icon" href="icon128.png" />
  <link rel="stylesheet" href="style.css" />

<script src="opera_wysiwyg/utils.js"></script>
<script src="opera_wysiwyg/editor.js"></script>
<script src="opera_wysiwyg/editlib.js"></script>
<script src="gp_editor.js"></script>

<script src="libs/jquery-1.7.1.min.js"></script>
<script src="libs/jquery-ui-1.8.18.custom.min.js"></script>
<link rel="stylesheet" type="text/css" href="jqueryui_css/ui-lightness/jquery-ui-1.8.18.custom.css"> 

  <script>
var mem = {};
var touch = {};
var gpe;

var postsCurrentlyDisplayed = [];

var lastUpdate = 0;

function val(name) {
  var $ = document.getElementById(name).value;
  return ($ ? $ : undefined);
}

function parseTimeField() {
  $('#timeParsed').text(new Date(val('time')).toString());
}

function sendPost(post) {
  chrome.extension.sendRequest({'type': 'post', 'post': post}, refresh);
}

function post(state) {
  var writeTimeStamp = Number(val('write_time_stamp') || 0);
  var post = {
    'state': state,
    'content': getContent() || '',
    'share_id': val('share_id'),
    'image_id': val('image_id'),
    'title': val('title'),
    'timeStamp': new Date(val('time')).getTime() || undefined,
    'link': val('link') || undefined,
    'touch': new Date().getTime()
  }
  if (writeTimeStamp) {
    post.writeTimeStamp = writeTimeStamp;
    var savedPost = mem[writeTimeStamp];
    if (savedPost) {
      post.reshare = savedPost.reshare;
    }
  } else {
    post.writeTimeStamp = new Date().getTime();
  }
  sendPost(post);
}

function processMediaItems(mediaArray) {
  var result = {'images': []};
  mediaArray.forEach(function(media) {
    if (media[24][4] == "image" || media[24][4] == "photo") {
      var url = media[41][0][1];
      if (!url.match(/http/)) {
        url = 'https:' + url;
      }
      var image = {'url': url};
      result.images.push(image);
    }
    var type = media[24][3];
    if (type == "text/html" || type == "application/x-shockwave-flash") {
      result.link = {'url': media[24][1], 'title': media[3], 'description': media[21]};
    }
    if (type == "application/x-shockwave-flash") {
      result.video = {'embed': media[5][1].replace(/autoplay=1/, ''), 'w': media[5][3], 'h': media[5][2]};
    }
  });
  return result;
}

function delPost() {
  var writeTimeStamp = Number(val('write_time_stamp'));
  if (document.getElementById('post' + writeTimeStamp)) {
    chrome.extension.sendRequest({'type': 'delPost', 'writeTimeStamp': writeTimeStamp}, refresh);
  } else {
    refresh();
  }
}

function getDateString(post) {
  if (post.state == 'scheduled') {
    return "Will be posted on " + new Date(post.timeStamp).toString();
  } else {
    return '';
  }
}

function publishDraft(writeTimeStamp) {
  chrome.extension.sendRequest({'type': 'publishDraft', 'writeTimeStamp': writeTimeStamp},
      function(ok) {
    if (ok) {
      var draftDiv = document.getElementById('post' + writeTimeStamp);
      draftDiv.parentElement.removeChild(draftDiv);
    }
  });
}

function getContent() {
  return gpe && gpe.getText();
}

function profileAutocompleter(prefix, callback) {
  chrome.extension.sendRequest({type: 'profileAutocomplete', prefix: prefix}, callback);
}

function addDraftEditBox(post) {
  if (!post) {
    post = {};
  }
  var writeTimeStamp = post.writeTimeStamp || '';
  var content = post.content || '';
  var share_id = post.share_id || '';
  var link = post.link || '';
  var image_id = post.image_id || '';
  var title = post.title || '';
  var time = post.timeStamp ? new Date(post.timeStamp).toString() : '';
  var medias;
  if (post.rawMedia) {
    medias = processMediaItems(post.rawMedia);
    link = medias.link && medias.link.url || '';
  }

  $('#title').val(title);
  $('#share_id').val(share_id);
  $('#link').val(link);
  $('#image_id').val(image_id);
  $('#time').val(time);
  $('#write_time_stamp').val(writeTimeStamp);

  $('#reshare').html(renderReshare(post));
  populateLinkMediaArea(post.rawMedia);

  if (gpe) {
    gpe.destroy();
  }
  gpe = new GPEditor(document.getElementById('content'),
      content, writeTimeStamp, profileAutocompleter);
}

function renderReshare(post) {
  if (!(post && post.reshare)) {
    return '';
  }
  var rs = post.reshare;
  return '<div class="reshare"><h2>' + rs.author_name + ' originally shared this ' +
         '<a href="' + rs.url + '">post</a> ' +
         (rs.via_name ? ' (via ' + rs.via_name + ')' : '') +
         ':</h2>' +
         '<p>' + rs.content.replace(/(class=\'ot-hashtag\' href=\')/g, "$1https://plus.google.com/") + '</p>' +
         (rs.rawMedia ? renderMediaItems(processMediaItems(rs.rawMedia)) : '') + "</div>";
}

function renderReshareMeta(post) {
  if (!(post && post.reshare)) {
    return '';
  }
  var rs = post.reshare;
  return '<span class="reshareMeta">Reshared post by ' + rs.author_name + '</span>';
}

function editDraft(writeTimeStamp) {
  chrome.extension.sendRequest({type: 'fetchPost', writeTimeStamp: writeTimeStamp},
      function(post) {
    // TODO: Save previous post as draft.
    $('body').animate({scrollTop: 0}, 450);
    stopRefreshing = true;
    addDraftEditBox(post);
  });
}

function bMinusA(a, b, key) {
  var aKeys = a.map(function(item){return item[key]});
  return b.filter(function(item) {
    return aKeys.indexOf(item[key]) == -1;
  });
}

function removeRemovedPosts(removedPosts) {
  removedPosts.forEach(function(post) {
    var p = $('#post' + post.writeTimeStamp);
    var interval = 1000;
    p.hide('blind', {}, interval);
    window.setTimeout(function() {
      p.remove();
    }, interval + 10);
  });
}

function getImgHtml(post) {
  function getMediaHtml(rawMedia) {
    var items = processMediaItems(rawMedia)
    var image = items.images[0];
    var video = items.video;
    if (video) {
      return "<iframe src='" + video.embed + "' width='260' ></iframe>";
    }
    if (image) {
      return "<img width='260' src='" + image.url + "' /" + ">";
    }
  };
  if (post.reshare && post.reshare.rawMedia) {
    return getMediaHtml(post.reshare.rawMedia);
  } else if (post.rawMedia) {
    return getMediaHtml(post.rawMedia);
  }
}

function renderAllPosts(posts) {
  if (!posts instanceof Array) {
    return;
  }
  var removedPosts = bMinusA(posts, postsCurrentlyDisplayed, 'writeTimeStamp');
  postsCurrentlyDisplayed = posts;
  removeRemovedPosts(removedPosts);
  posts.forEach(function(post) {
    renderPost(post);
  });
}

function renderPost(post) {
  if (post.touch && post.touch == touch[post.writeTimeStamp]) {
    return;
  }
  touch[post.writeTimeStamp] = post.touch;
  var div = document.createElement('div');
  var date = getDateString(post);
  var title = post.title || '';

  var attachmentHTML = '';
  var postImage = getImgHtml(post) || '';

  div.id = 'post' + post.writeTimeStamp;
  div.onclick = function() {
    editDraft(post.writeTimeStamp);
  };

  var isDraft = (post.state == 'draft');
  var wasDraft = !!document.querySelector('.drafts #' + div.id);
  var stateChange = !!(isDraft ^ wasDraft);
  div.className = 'savedPost';

  var content = trimContent(post.content);

  // Don't look at this :(
  div.innerHTML = (date && "<p class='postDate'>" + date + "</p>") +
                  (title && "<span class='postTitle'>" + title + "</span>") +

                  GPEditor.prototype.plusFormatToHtml(content) +
                  renderReshareMeta(post) +
                  "<br>" + postImage;

  var existing = document.getElementById(div.id);
  var column = $('#posts ' + (isDraft ? '.drafts' : '.scheduled') + ' .postsList');
  if (existing) {
    if (stateChange) {
      removeRemovedPosts([post]);
      addPostToColumn(div, column[0]);
    } else {
      existing.innerHTML = div.innerHTML;
    }
  } else {
    addPostToColumn(div, column[0]);
  }
}

function addPostToColumn(div, column) {
  if (lastUpdate == 0) {
    $(column).prepend(div);
  } else {
    $(div).addClass('invisible').prependTo($(column));
    window.setTimeout(function(){$(div).removeClass('invisible');}, 1);
  }
}

function trimContent(string) {
  if (!string || !(string > '')) {
    return string;
  }
  var maxChars = 350;
  var trimmed = string.match(/(^[^\n]*\n[^\n]*\n[^\n]*\n[^\n]*\n)/);
  if (trimmed && trimmed[0]) {
    // Content has line breaks.
    return trimmed[0].replace(/[\n]+$/, '\n&hellip;');
  } else {
    if (string.length > maxChars + 40) {
      string = string.substring(0, maxChars).replace(/\s+$/, '') + '&hellip;';
    }
    return string;
  }
}

function renderMediaItems(medias) {
  // TODO: Scroll through images.
  var image = medias.images[0];
  var video = medias.video;
  var link = medias.link;

  return (link && link.title ?
      "<a href='" + link.url +"'>" +
      "<h3>" + link.title + "</h3></a>" : "") +

  (image ? "<img src='" + image.url + "'><br>" : "") +

  (video ? "<iframe src='" + video.embed + "' width='" + video.w / 2 +
      "' height='" + video.h / 2 + "' ></iframe>" : '') +

  (link && link.description ? "<p>" + link.description + "</p>" : "");
}

function refresh() {
  addDraftEditBox();
  refreshPosts();
}

function showScheduleBar() {
  $('#scheduleBar').show();
}

var stopRefreshing;
function refreshPosts() {
  stopRefreshing = false;
  chrome.extension.sendRequest({'type': 'fetchAll'}, function(result) {
    if (stopRefreshing || result.lastUpdate == lastUpdate) {
      return;
    }
    result.posts && renderAllPosts(result.posts);
    lastUpdate = result.lastUpdate;
  });
}

function refreshIfNeeded() {
  if (!stopRefreshing) {
    refreshPosts();
  }
  window.setTimeout(refreshIfNeeded, 300);
}

function populateLinkMediaArea() {
  var link = $('#link').val();
  if (!link) {
    $('#postMedia').hide('blind', 500, function(){$(this).html('')});
    return;
  }
  chrome.extension.sendRequest({type: 'getLinkMedia', link: link}, function(rawMedia) {
    if (rawMedia) {
      $('#postMedia').html(renderMediaItems(processMediaItems(rawMedia)))
          .show('blind', 500);
    }
  });
}

function setListeners() {
  $('#addLink').delegate('.enabled', 'click', function() {
    $('#linkBar').show('blind', 200);
    $(this).removeClass('enabled');
    $(this).addClass('disabled');
  });
  $('#addLink').delegate('.disabled', 'click', function() {
    $('#linkBar').hide('blind', 200);
    $(this).removeClass('disabled');
    $(this).addClass('enabled');
  });
  $('#closeLinkBar').click(function() {
    $('#addLink').children().click();
  });
  $('#submitLink').click(function() {
    $('#link').val($('#linkInput').val());
    $('#addLink').children().click();
    populateLinkMediaArea();
  });
  $('#linkInput').keydown(function(e) {
    if (e.keyCode == 13) {
      $('#submitLink').click();
    }
  });
  $('#buttonSchedule').click(function() {
    var jself = $(this);
    if (jself.data('active')) {
      $('#scheduleBar').hide('blind', 200);
      jself.removeClass('opened');
      jself.addClass('closed');
      jself.data('active', null);
    } else {
      $('#scheduleBar').show('blind', 200);
      jself.removeClass('closed');
      jself.addClass('opened');
      jself.data('active', true);
    }
  });
  $('#closeScheduleBar').click(function() {
    $('#buttonSchedule').click();
  });
}

function onLoad() {
  var savedPostJson = localStorage['_tmp_post'];
  var savedPost;
  if (savedPostJson) {
    savedPost = JSON.parse(savedPostJson);
    mem[savedPost.writeTimeStamp] = savedPost;
  }
  localStorage.clear('_tmp_post');
  addDraftEditBox(savedPost);
  setListeners();
  refreshIfNeeded();
}

  </script>
</head>
<body onload="onLoad()">
  <div id="appWrap">
    <div id="top">
      <header><h1>Do Share</h1></header>
    </div>
    <div id="editbox">
      <div class="titleBar"><input id="title" placeholder="Title (optional)" /></div>
      <div id="content" class="editbox"></div>
      <div id="postActions">
        <div class="postAction" id="addLink"><span class="enabled">U</span></div>
      </div>
      <div id="attachments">
        <div id="reshare"></div>
        <div id="linkBar">
          <input id="linkInput" placeholder="link" />
          <button id="submitLink">Add</button>
          <div id="closeLinkBar" class="xButton">x</div>
        </div>
        <div id="postMedia"></div>
      </div>
      <input type="hidden" id="link" />
      <input type="hidden" id="image_id" />
      <input type="hidden" id="share_id" />
      <input type="hidden" id="write_time_stamp" />
    </div>
    <div id="buttonBar">
      <button onclick="delPost()" id="buttonDelete">delete post :(</button>
      <button onclick="post('draft')" id="buttonDraft">save draft</button>
      <button id="buttonSchedule" class="closed">schedule</button>
      <button onclick="post('post')" id="buttonPost">share now</button>
    </div>
    <div id="scheduleBar">
      <div id="closeScheduleBar" class="xButton">x</div>
      <p><input id="time" placeholder="Time" /><button onclick="parseTimeField()">Parse</button></p>
      <p id="timeParsed"></p>
      <button onclick="post('scheduled')" id="buttonScheduleStepTwo">schedule</button>
    </div>
    <div id="posts">
      <div class="column drafts">
        <div class="columnHead">drafts</div>
        <div class="postsList"></div>
      </div>
      <div class="column scheduled">
        <div class="columnHead">scheduled</div>
        <div class="postsList"></div>
      </div>
    </div>
  </div>
