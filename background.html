<script type="text/javascript" src="/libs/jquery-1.6.3.min.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_helper.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_abstract_database.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_database.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_for_google_plus.js"></script>

<script src="IDBWrap/wrap.js"></script>
<script src="/Sched5.js"></script>
<script>

function checkInit(ok) {
  if (!ok) {
    window.setTimeout(function() {
      plus.init(checkInit);
    }, 1000);
  } else {
    plus.refreshInfo();
  }
}
checkInit(false);

function c(e){console.log(e)}

var db = new IDBWrap("nightwatchDb", "writeTimeStamp");
db.init(c);

var s = new Sched5("nightwatch", "writeTimeStamp", publish, c);
s.init(c);

// Set up the API
var plus = new GooglePlusAPI();

function publish(post, callback) {
  plus.newPost(callback || c, post);
  console.log("Posting");
  console.log(post);
}

function schedule(post, callback) {
  db._removeItem(post.writeTimeStamp, function() {
    s.schedule(post, post.timeStamp, callback);
  });
}

function draft(post, callback) {
  delPost(post.writeTimeStamp, function(){});
  db.put(post, callback);
}

function addPost(post, callback) {
  var state = post.state;

  if (state == "scheduled") {
    schedule(post, callback);
  } else if (state == "draft") {
    draft(post, callback);
  } else if (state == "post") {
    publish(post, callback);
  } else {
    console.error('Invalid state');
    callback(false);
  }
}

function fetchAll(callback) {
  var result = {'posts': []};
  var wrapCallback = function() {
    s.count(function(count) {
      if (count == 0) {
        callback(result);
      }
      s.processAllItems(function(item) {
        result.posts.push(item);
        if (--count == 0) {
          callback(result);
        }
      });
    });
  }
  db.count(function(count) {
    if (count == 0) {
      wrapCallback();
    }
    db._processAllItemsByRange(undefined, function(post) {
      post.timeStamp = undefined;
      result.posts.push(post);
      if (--count == 0) {
        wrapCallback();
      }
    });
  });
}

function publishDraft(writeTimeStamp, callback) {
  db.processItem(writeTimeStamp, function(post) {
    db._removeItem(writeTimeStamp, function(ok) {
      if (ok) {
        // TODO: go back to a sane state if posting failed.
        publish(post, callback);
      } else {
        console.error('Unable to remove item by key: ' + writeTimeStamp);
        callback(false);
      }
    });
  });
}

function fetchPost(writeTimeStamp, callback) {
  var race = false;
  var racer = function(item) {
    if (race) {
      // How did this happen? The assumption is that a post is is in only one of db, s.
      console.error("WTF");
      return;
    }
    race = true;
    callback(item);
  };
  db.processItem(writeTimeStamp, racer);
  s.processItem(writeTimeStamp, racer);
}

function delPost(writeTimeStamp, callback) {
  s._removeItem(writeTimeStamp, c);
  db._removeItem(writeTimeStamp, c);
  // If you're not me and here because of a bug, I owe you a beer.
  callback(true);
}

function onRequest(request, sender, callback) {
  var type = request.type;
  if (type == "post") {
    var post = request.post;
    if (!post) {
      console.error('Missing request.post');
      callback(false);
      return
    }
    var state = request.state;
    if (!state) {
      console.error('Missing request.state');
      callback(false);
      return;
    }
    if (post.link) {
      plus.fetchLinkMedia(function(response) {
        if (response.items) {
          post.rawMedia = response.items;
        }
        addPost(post, callback);
      }, post.link);
    } else {
      addPost(post, callback);
    }
  } else if (type == "fetchAll") {
    fetchAll(callback);
  } else if (type == "delPost") {
    delPost(request.writeTimeStamp, callback);
  } else if (type == "publishDraft") {
    var writeTimeStamp = request.writeTimeStamp;
    if (!writeTimeStamp) {
      console.error("Invalid request.writeTimeStamp");
      callback(false);
    } else {
      publishDraft(writeTimeStamp, callback);
    }
  } else if (type == "fetchPost") {
    fetchPost(request.writeTimeStamp, callback);
  }
}
chrome.extension.onRequest.addListener(onRequest);

</script>
