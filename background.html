<script type="text/javascript" src="/libs/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_helper.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_abstract_database.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_database.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_for_google_plus.js"></script>

<script src="/browser_action_controller.js"></script>

<script src="IDBWrap/wrap.js"></script>
<script src="/Sched5.js"></script>

<script>
// HACKKKKKKKKKKK
function Editor(){};
</script>
<script src="gp_editor.js"></script>
<script>

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-27041781-6']);

function trackPost(post) {
  var pub = false;
  if (post.entities && post.entities.filter(function(entity) {
    return entity.circleId == 'PUBLIC';
  }).length) {
    pub = true;
  }
  _gaq.push(['_trackEvent', 'Post', (pub ? 'public' : 'limited')]);
  if (post.circlesNotifyArray && post.circlesNotifyArray.length) {
    _gaq.push(['_trackEvent', 'NotifyCircles', (pub ? 'public' : 'limited'), 'NotifyCircles', post.circlesNotifyArray.length]);
  }
}

var ACTION_UPDATE_INTERVAL = 666;
var INIT_RETRY_INTERVAL = 5 * 1000;
var INIT_REPEAT_INTERVAL = 15 * 60 * 1000;

var dbInit = false;
var dbInitCounter = 2;
function dbInitCallback(ok) {
  if (ok) {
    if (--dbInitCounter == 0) {
      dbInit = true;
    }
  }
}

// Set up the API
var plus = new GooglePlusAPI();
var apis = {};

function initialize() {
  try {
    plus.init(function(response) {
      if (response.status) {
        var uid = plus.getInfo().id;
        if (uid != localStorage['prev_uid']) {
          oauth.clearTokens();
        }
        localStorage['prev_uid'] = uid;
        plus.getAllIdentitiesApis(function(result) {
          console._error = console.error;
          console.error = console.warn;
          var count = result.length;
          result.forEach(function(api) {
            if (!(api.getInfo() && api.getInfo().id == uid)) {
              api.init(function() {
                apis[api.getInfo().id] = api;
              });
            } else {
              apis[api.getInfo().id] = api;
            }
            api.refreshCircles(function() {
              if (--count == 0) {
                console.error = console._error;
              }
            });
          });
        });

        window.setTimeout(initialize, INIT_REPEAT_INTERVAL);
      } else {
        window.setTimeout(initialize, INIT_RETRY_INTERVAL);
      }
    });
  } catch (e) {
    _gaq.push(['_trackEvent', 'Failure', 'plus.init']);
    console.error(e);
    window.setTimeout(initialize, INIT_RETRY_INTERVAL);
  }
};
initialize();

var lastUpdate = -1;
function update() {
  lastUpdate = new Date().getTime();
}

function c(e){console.log(e)}

var s;
var db = new IDBWrap("nightwatchDb", "writeTimeStamp");
db.init(function(ok){
  dbInitCallback(ok);
  s = new Sched5("nightwatch", "writeTimeStamp", publishScheduled, handleMissedPost);
  s.init(dbInitCallback);
});

var actionController = new BrowserActionController();

// HACKKKKK
var fakeDiv = document.createElement('div');
var gpe = new GPEditor(fakeDiv, '', 'fake', function(){}, {}, true);

var previousTotal;
var previousLogicBits;
function updateAction(numDrafts, numScheduled) {
  var hasScheduled = (numScheduled > 0);

  var total = numDrafts + numScheduled;
  var logicBits = !!total + hasScheduled << 1;
  if (total == previousTotal && logicBits == previousLogicBits) {
    return;
  }
  previousTotal = total;
  previousLogicBits = logicBits;

  var badgeText = "Do Share - ";
  function s(count) {
    if (count == 1) {
      return '';
    }
    return 's';
  }
  if (total == 0) {
    badgeText += "Ready";
  } else if (hasScheduled) {
    badgeText += numScheduled + " post" + s(numScheduled) + " scheduled, " + numDrafts + " draft" + s(numDrafts) + " saved";
  } else {
    badgeText += numDrafts + " draft" + s(numDrafts) + " saved";
  }
  actionController.drawBadgeIcon(total, badgeText, hasScheduled);
}

(function refreshAction() {
  if (dbInit) {
    var waiting = 2;
    var numDrafts = 0;
    var numScheduled = 0;
    var waiter = function() {
      if (--waiting == 0) {
        updateAction(numDrafts, numScheduled);
      }
    }
    db.count(function(count) {
      numDrafts = count;
      waiter();
    });
    s.count(function(count) {
      numScheduled = count;
      waiter();
    });
  }
  window.setTimeout(refreshAction, ACTION_UPDATE_INTERVAL);
})();

/**
 * Thanks Hangout Canopy team!
 */
function fetchOzData(url, callback) {
  $.ajax(url).done(function(responseText) {
    var re = /<script\b[^>]*>([\s\S]*?)<\/script>/gm;
    var matches = [];
    var match;
    var AF_initDataChunkQueue = [];

    /*
     * Take outall the script tags
     */
    while (match = re.exec(responseText)) {
      if(match[1] && match[1].indexOf('AF_initData') > -1) {
        eval(match[1]);
      }
    }

    /*
     * Thankyou Google :)
     */
    var initDataMap = {};
    for (var i = 0; i < AF_initDataChunkQueue.length; i++) {
      var dataPair = AF_initDataChunkQueue[i];
      if (dataPair.key != '-1') {
        initDataMap[dataPair.key] = dataPair.data;
      }
    }
    callback(initDataMap);
  });
}

function fetchPostData(url, callback) {
  if (!url > '') {
    console.error('Url is not a string');
    return;
  }

  fetchOzData(url, function(dataMap) {
    var postData = dataMap && dataMap[20];
    if ((!dataMap) || (!postData)) {
      _gaq.push(['_trackEvent', 'Failure', 'fetchOzData']);
      console.error('Not a singleton post url');
      return;
    }

    // TODO: postData[43] has 2nd level via information which could be useful one day.
    var reshare_person_data = postData[44];

    var data = {};
    var name = postData[3];
    var id = postData[16];

    data.content = postData[4];
    data.update_id = postData[8];
    data.url = 'https://plus.google.com/' + postData[21];
    data.timeStamp = postData[5];
    data.isPublic = (postData[32] === 1);

    if (!reshare_person_data) {
      data.author_name = name;
      data.author_id = id;
      data.author_photo_url = 'https:' + postData[18];
    } else {
      data.author_name = reshare_person_data[0];
      data.author_id = reshare_person_data[1];
      data.author_photo_url = reshare_person_data[4];
      data.via_name = name;
      data.via_id = id;
    }

    data.rawMedia = postData[11];
    data.medias = processMediaItems(data.rawMedia);

    callback(data);
  });
}

/**
 * callback = function(person<Array>) (see gp_editor)
 */
function profileAutocomplete(prefix, callback) {
  if (!prefix) {
    callback([]);
    return;
  }
  plus.profileAutocomplete(function(response) {
    var results = response[1];
    if (!results) {
      callback([]);
    }

    var persons = [];
    for (var i = 0; i < results.length; ++i) {
      var personObject = results[i];
      var personData = results[i][3][0];
      var person = {
        name: (personData['n'] ? personData['n'] : personObject[0]),
        id: personData['g']
      };
      if (personData['p']) {
        person.photoUrl = 'https:' + personData['p'] + '?sz=24';
      }
      persons.push(person);
    }
    callback(persons);
  }, prefix);
}

function handleMissedPost(post) {
  post.state = 'draft';
  _gaq.push(['_trackEvent', 'MissedPost', 'MissedPost']);
  post.error = 'Chrome was not running at the scheduled time';
  addPost(post, c);
}

function publishScheduled(post) {
  update();
  publish(post);
}

function publish(post, callback) {
  var postBackup = JSON.stringify(post);
  trackPost(post);
  if (post.title) {
    post.content = '*' + post.title.replace(/(\s|&nbsp;)+$/, '') + '*\n\n' + post.content;
  }
  if (post.entities instanceof Array) {
    post.aclItems = parseEntities(post.entities);
  }
  if (post.rawMedia && post.rawMedia[0] && post.rawMedia[0][47] && post.rawMedia[0][47][0] &&
      post.rawMedia[0][47][0][1] == 'picasa') {
    post.isPicasaImage = true;
  }
  var wrapCallback = function(response) {
    if (!callback) {
      callback = c;
    }
    if (response.status == false) {
      _gaq.push(['_trackEvent', 'Failure', 'newPost']);
      post = JSON.parse(postBackup);
      post.state = 'draft';
      post.error = "Could not send post to Google+";
      // Avoid UI races by upping the failed posts's id.
      post.writeTimeStamp += 1;
      addPost(post, callback);
    } else {
      callback(true);
    }
  };
  plus.newPost(wrapCallback, post);
  console.log("Posting");
  console.log(post);
}

function schedule(post, callback) {
  s.schedule(post, post.timeStamp, callback);
}

function draft(post, callback) {
  db.put(post, callback);
}

function addPost(post, callback) {
  var state = post.state;
  update();

  delPost(post.writeTimeStamp, function(){});
  if (state == "scheduled") {
    schedule(post, callback);
  } else if (state == "draft") {
    draft(post, callback);
  } else if (state == "post") {
    publish(post, callback);
  } else {
    _gaq.push(['_trackEvent', 'Failure', 'Invalid']);
    console.error('Invalid state');
    callback(false);
  }
}

function fetchAll(callback) {
  if (!dbInit) {
    return;
  }
  var result = {posts: [], lastUpdate: lastUpdate};
  var wrapCallback = function() {
    s.count(function(count) {
      if (count == 0) {
        callback(result);
      } else {
        s.processAllItems(function(item) {
          result.posts.push(item);
          if (--count == 0) {
            callback(result);
          }
        });
      }
    });
  };
  db.count(function(count) {
    if (count == 0) {
      wrapCallback();
    } else {
      db._processAllItemsByRange(undefined, function(post) {
        result.posts.push(post);
        if (--count == 0) {
          wrapCallback();
        }
      });
    }
  });
}

function processMediaItems(mediaArray) {
  var result = {images: [], rawMedia: mediaArray};
  mediaArray.forEach(function(media) {
    if (media[24][4] == "image" || media[24][4] == "photo") {
      var url;
      if (media[5]) {
        url = media[5][1];
      } else if (media[41]) {
        url = media[41][0][1];
      } else {
        url = media[24][1];
      }
      if (!url.match(/http/)) {
        url = 'https:' + url;
      }
      var image = {'url': url};
      result.images.push(image);
    }
    var type = media[24][3];
    if (type && type.match("^text/") || type == "application/x-shockwave-flash") {
      result.link = {'url': media[24][1], 'title': media[3], 'description': media[21]};
    }
    if (type == "application/x-shockwave-flash") {
      result.video = {'embed': getVideoEmbed(media[5][1]), 'w': media[5][3], 'h': media[5][2]};
    }
  });
  return result;
}

function processFrontendMedias(medias) {
  if (medias.change) {
    var change = medias.change;
    if (change.chosenImageIndex) {
      medias.rawMedia = keepNthImage(medias.rawMedia, change.chosenImageIndex);
    }
    if (change.removeDescription) {
      medias.rawMedia = removeDescription(medias.rawMedia);
    }
  }
  return medias.rawMedia;
}

function removeDescription(rawMedia) {
  rawMedia.forEach(function(media) {
    var type = media[24][3];
    if (type == "text/html" || type == "application/x-shockwave-flash") {
      media[21] = '';
    }
  });
  return rawMedia;
}

function keepNthImage(rawMedia, n) {
  var result = [];
  for (var i = 0, j = 0; i < rawMedia.length; ++i) {
    var media = rawMedia[i];
    if (media[24][4] == "image" || media[24][4] == "photo") {
      if (j++ == n) {
        result.push(media);
      }
    } else {
      result.push(media);
    }
  }
  return result;
}

function getVideoEmbed(embedUrl) {
  embedUrl = embedUrl.replace('autoplay', 'noplay');
  if (embedUrl.match('youtube.com/v/')) {
    var v = embedUrl.match('/v/(.*?)[?&]')[1];
    return 'https://www.youtube.com/embed/' + v + '?wmode=opaque';
  } else {
    return embedUrl;
  }
}

function fetchPost(writeTimeStamp, callback) {
  var race = false;
  var racer = function(item) {
    if (race) {
      // How did this happen? The assumption is that a post is is in only one of db, s.
      _gaq.push(['_trackEvent', 'Failure', 'fetchPostRaceWTF']);
      console.error("WTF");
      return;
    }
    race = true;
    callback(item);
  };
  db.processItem(writeTimeStamp, racer);
  s.processItem(writeTimeStamp, racer);
}

function delPost(writeTimeStamp, callback) {
  update();
  s._removeItem(writeTimeStamp, c);
  db._removeItem(writeTimeStamp, c);
  // If you're not me and here because of a bug, I owe you a beer.
  callback(true);
}

function post(post, callback) {
    if (post.state == 'scheduled' && post.timeStamp < new Date().getTime()) {
      callback(false);
      return;
    }
    if (!post) {
      _gaq.push(['_trackEvent', 'Failure', 'MissingRequestPost']);
      console.error('Missing request.post');
      callback(false);
      return
    }
    var state = post.state;
    if (!state) {
      _gaq.push(['_trackEvent', 'Failure', 'MissingPostState']);
      console.error('Missing post.state');
      callback(false);
      return;
    }

    function postThis() {
      var a = post.circlesNotifyArray;
      post.notify = [];
      if (a && a.length > 0) {
        var len = a.length;
        a.forEach(function(id) {
          plus.getPeople({circle_id: id}, function(result) {
            if (result.data) {
              result.data.forEach(function(person) {
                post.notify.push(person.id);
              });
            }
            len--;
            if (len == 0) {
              addPost(post, callback);
            }
          })
        });
      } else {
        addPost(post, callback);
      }
    }

    // If reshare, don't waste time on fetching media links.
    if (post.reshare) {
      if (post.reshare.rawMedia) {
        post.reshare.medias = processMediaItems(post.reshare.rawMedia);
      }
      postThis();
    } else if (post.medias) {
      // Dance for me.
      post.rawMedia = processFrontendMedias(post.medias);
      post.medias = processMediaItems(post.rawMedia);
      postThis();
    } else if (post.link) {
      getLinkMedia(post.link, function(data) {
        if (data) {
          post.rawMedia = data;
          post.medias = processMediaItems(data);
        }
        postThis();
      });
    } else if (post.image_id) {
      plus.fetchPhotoMetadata(function(response) {
        if (response.error || !response.data) {
          _gaq.push(['_trackEvent', 'Failure', 'fetchPhotoMetadata']);
          console.error(response);
          callback(false);
        } else {
          post.rawMedia = [plus._createPicasaImageItem(response.data)];
          post.medias = processMediaItems(post.rawMedia);
          postThis();
        }
      }, post.image_id);
    } else {
      postThis();
    }
}

function getLinkMedia(link, callback) {
  if (!link) {
    console.error('invalid link');
    return;
  }
  plus.fetchLinkMedia(function(response) {
    if (!response.status) {
      _gaq.push(['_trackEvent', 'Failure', 'fetchLinkMedia']);
      console.error('Error fetching media for ' + link);
    }
    if (response.data) {
      callback(response.data);
    }
  }, link);
}

function newPost(post) {
  function openNewPost() {
    // Set temporary values and open the frontend. Expect frontend to clear these from LS.
    localStorage['_tmp_post'] = JSON.stringify(post);
    chrome.tabs.create({'url': chrome.extension.getURL('main.html')}, c);
  }
  if (!post.entities) {
    var lastUsed = localStorage['lastUsedCircles'];
    if (lastUsed) {
      post.entities = JSON.parse(lastUsed);
    } else {
      post.entities = [];
    }
  }
  if (post.image_id) {
    plus.fetchPhotoMetadata(function(response) {
      if (response.error || !response.data) {
        _gaq.push(['_trackEvent', 'Failure', 'fetchPhotoMetadata']);
        console.error(response);
        callback(false);
      } else {
        post.rawMedia = [plus._createPicasaImageItem(response.data)];
        post.medias = processMediaItems(post.rawMedia);
        openNewPost();
      }
    }, post.image_id);
  } else {
    openNewPost();
  }
}

function resharePost(url, htmlContent, mentioned) {
  // HACKKKKKKKKKKK
  var div = document.createElement('div');
  div.innerHTML = htmlContent || '';
  var content = gpe.visitNormalizedHtmlNode(div);
  fetchPostData(url, function(data) {
    if (htmlContent && mentioned) {
      var postIdentifier;
      if (!data.via_id) {
        postIdentifier = 'the original post';
      } else {
        mentioned[data.via_id] = data.via_name;
        postIdentifier = '@' + data.via_id + '\'s reshare of the original post';
      }
      content = content.replace('${DS_POST_IDENTIFIER}', postIdentifier);
    }
    var post = {reshare: data,
                share_id: data.update_id,
                content: content,
                mentioned: mentioned,
                writeTimeStamp: new Date().getTime()};
    var lastUsed = localStorage['lastUsedCircles'];
    if (lastUsed && data.isPublic) {
      post.entities = JSON.parse(lastUsed);
    } else {
      post.entities = [];
    }
    newPost(post);
  });
}

function parseEntities(entities) {
  if (!(entities instanceof Array)) {
    return;
  }
  return entities.map(function(entity) {
    if (entity.circleId) {
      var id = entity.circleId;
      if (id == 'PUBLIC') {
        return {type: GooglePlusAPI.AclType.PUBLIC};
      } else if (id == 'EXTENDED_CIRCLES') {
        return {type: GooglePlusAPI.AclType.EXTENDED_CIRCLES};
      } else if (id == 'YOUR_CIRCLES') {
        return {type: GooglePlusAPI.AclType.YOUR_CIRCLES};
      } else {
        return {
          type: GooglePlusAPI.AclType.SPECIFIED_CIRCLE,
          id: id
        }
      }
    } else if (entity.personId) {
      return {
        type: GooglePlusAPI.AclType.SPECIFIED_PERSON,
        id: entity.personId
      }
    }
  });
}

function onRequest(request, sender, callback) {
  var type = request.type;
  if (type == "post") {
    post(request.post, callback);
  } else if (type == "fetchAll") {
    fetchAll(callback);
  } else if (type == "delPost") {
    delPost(request.writeTimeStamp, callback);
  } else if (type == "fetchPost") {
    fetchPost(request.writeTimeStamp, callback);
  } else if (type == "newPost") {
    newPost({content: request.content || '',
             link: request.link || '',
             image_id: request.image_id || '',
             writeTimeStamp: new Date().getTime()});
    _gaq.push(['_trackEvent', 'Source', request.source || 'unknown']);
  } else if (type == "resharePost") {
    resharePost(request.url, request.htmlContent, request.mentioned);
    _gaq.push(['_trackEvent', 'Source', (request.htmlContent ? 'commentReshare' : 'streamReshare')]);
  } else if (type == 'getId') {
    if (!plus.isAuthenticated()) {
      plus.init(c);
    }
    var info = plus.getInfo();
    if (plus.isAuthenticated() && info) {
      callback({'id': plus.getInfo().id});
    } else {
      callback({})
    }
  } else if (type == 'profileAutocomplete') {
    profileAutocomplete(request.prefix, callback);
  } else if (type == 'getLinkMedia') {
    getLinkMedia(request.link, function(rawMedia) {
      callback(processMediaItems(rawMedia));
    });
  } else if (type == 'getCircles') {
    plus.getCircles(function(response) {
      if (response.status) {
        callback(response.data);
      }
    });
  } else if (type == 'oauthAuthenticate') {
    oauth.authorize(callback);
  }
}

chrome.extension.onRequest.addListener(onRequest);
chrome.browserAction.onClicked.addListener(function(tab) {
  if (tab.url.match(/^http/) && !tab.url.match(/http(|s):\/\/(plus|mail).google.com/)) {
    localStorage['_tmp_tab'] = JSON.stringify(tab);
  }
  chrome.tabs.create({url: chrome.extension.getURL('main.html'),
                      index: tab.index + 1}, c);
});

(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = 'https://ssl.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

</script>
<script src="oauth/chrome_ex_oauth.js"></script>
<script src="oauth/chrome_ex_oauthsimple.js"></script>
<script>
// Oauth setup
var oauth = ChromeExOAuth.initBackgroundPage({
  'request_url': 'https://www.google.com/accounts/OAuthGetRequestToken',
  'authorize_url': 'https://www.google.com/accounts/OAuthAuthorizeToken',
  'access_url': 'https://www.google.com/accounts/OAuthGetAccessToken',
  'consumer_key': 'anonymous',
  'consumer_secret': 'anonymous',
  'scope': 'https://picasaweb.google.com/data/',
  'app_name': 'Do Share'
});
</script>
