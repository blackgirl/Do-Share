<script type="text/javascript" src="/libs/jquery-1.6.3.min.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_helper.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_abstract_database.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_database.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_for_google_plus.js"></script>

<script src="/Sched5.js"></script>
<script>

function checkInit(ok) {
  if (!ok) {
    window.setTimeout(function() {
      plus.init(checkInit);
    }, 1000);
  } else {
    plus.refreshInfo();
  }
}
checkInit(false);

function c(e){console.log(e)}

function publish(post) {
  plus.newPost(c, post);
  localStorage[POST_COUNT_VAR]--;
}

var s = new Sched5("nightwatch", publish, c);
s.init(c);

localStorage['a'] = 0;

window.setInterval(function() {localStorage['a']++;}, 1000);

// Set up the API
var plus = new GooglePlusAPI();

function schedule(post, timeStamp, c) {
  s.schedule(post, timeStamp, c);
}

function onRequest(request, sender, callback) {
  var type = request.type;
  if (type == "post") {
    var post = request.post;
    if (post) {
      if (post.link) {
        plus.fetchLinkMedia(function(response) {
          if (response.items) {
            post.rawMedia = response.items;
          }
          schedule(post, request.time, c);
        }, post.link);
      } else {
        schedule(post, request.time, c);
      }
    }
  } else if (type == "fetchAll") {
    var result = {'posts': []};
    s.count(function(count) {
      if (count == 0) {
        callback(result);
      }
      s.processAllItems(function(item) {
        result.posts.push(item);
        if (--count == 0) {
          callback(result);
        }
      });
    });
  }
}
chrome.extension.onRequest.addListener(onRequest);

</script>
