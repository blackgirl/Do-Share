<script type="text/javascript" src="/libs/jquery-1.6.3.min.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_helper.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_abstract_database.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_database.js"></script>
<script type="text/javascript" src="/jsapi/jsapi_for_google_plus.js"></script>

<script src="IDBWrap/wrap.js"></script>
<script src="/Sched5.js"></script>
<script>

function checkInit(ok) {
  if (!ok) {
    window.setTimeout(function() {
      plus.init(checkInit);
    }, 1000);
  } else {
    plus.refreshInfo();
  }
}
checkInit(false);

function c(e){console.log(e)}

var db = new IDBWrap("nightwatchDb", "writeTimeStamp");
db.init(c);

var s = new Sched5("nightwatch", publish, c);
s.init(c);

// Set up the API
var plus = new GooglePlusAPI();

function publish(post, callback) {
  plus.newPost(callback || c, post);
}

function schedule(post, c) {
  db._removeItem(post.writeTimeStamp, function() {
    s.schedule(post, post.timeStamp, c);
  });
}

function draft(post, c) {
  db._removeItem(post.writeTimeStamp, function() {
    db.put(post, c);
  });
}

function addPost(post, state, callback) {
  if (state == "scheduled") {
    schedule(post, callback);
  } else if (state == "draft") {
    draft(post, callback);
  } else if (state == "post") {
    publish(post, callback);
  } else {
    console.error('Invalid state');
    callback(false);
  }
}

function fetchAll(callback) {
  var result = {'posts': []};
  var wrapCallback = function() {
    s.count(function(count) {
      if (count == 0) {
        callback(result);
      }
      s.processAllItems(function(item) {
        result.posts.push(item);
        if (--count == 0) {
          callback(result);
        }
      });
    });
  }
  db.count(function(count) {
    if (count == 0) {
      wrapCallback();
    }
    db._processAllItemsByRange(undefined, function(post) {
      post.timeStamp = undefined;
      result.posts.push(post);
      if (--count == 0) {
        wrapCallback();
      }
    });
  });
}

function publishDraft(writeTimeStamp, callback) {
  db.processItem(writeTimeStamp, function(post) {
    db._removeItem(writeTimeStamp, function(ok) {
      if (ok) {
        // TODO: go back to a sane state if posting failed.
        publish(post, callback);
      } else {
        console.error('Unable to remove item by key: ' + writeTimeStamp);
        callback(false);
      }
    });
  });
}

function onRequest(request, sender, callback) {
  var type = request.type;
  if (type == "post") {
    var state = request.state;
    if (!state) {
      console.error('Missing request.state');
      callback(false);
      return;
    }
    var post = request.post;
    if (!post) {
      console.error('Missing request.post');
      callback(false);
    } else {
      if (post.link) {
        plus.fetchLinkMedia(function(response) {
          if (response.items) {
            post.rawMedia = response.items;
          }
          addPost(post, state, callback);
        }, post.link);
      } else {
        addPost(post, state, callback);
      }
    }
  } else if (type == "fetchAll") {
    fetchAll(callback);
  } else if (type == "delPost") {
    var state = request.state;
    if (state == 'scheduled') {
      s._removeItem(request.timeStamp, callback);
    } else if (state == 'draft') {
      db._removeItem(request.timeStamp, callback);
    } else {
      console.error('Invalid request.state');
      callback(false);
      return;
    }
  } else if (type == "publishDraft") {
    var writeTimeStamp = request.writeTimeStamp;
    if (!writeTimeStamp) {
      console.error("Invalid request.writeTimeStamp");
      callback(false);
    } else {
      publishDraft(writeTimeStamp, callback);
    }
  } else if (type == "fetchPost") {
    if (request.state == 'draft') {
      db.processItem(request.writeTimeStamp, callback);
    }
  }
}
chrome.extension.onRequest.addListener(onRequest);

</script>
